<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Zonos API Playground</title>
    <style>
        :root {
            --bg: #1a1a26;
            --card: rgba(255,255,255,0.08);
            --card-border: rgba(255,255,255,0.13);
            --teal: #00B9B7;
            --purple: #3122F6;
            --gradient: linear-gradient(135deg, #00B9B7 0%, #3122F6 100%);
            --text: #e8eaf0;
            --text-muted: rgba(255,255,255,0.45);
            --text-dim: rgba(255,255,255,0.28);
            --border: rgba(255,255,255,0.09);
            --hover-border: rgba(0,185,183,0.4);
            --input-bg: rgba(255,255,255,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85vw; height: 85vh;
            background-image: url('cipher.png');
            opacity: 0.12;
            filter: invert(1);
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 20px 0 15px;
            margin-bottom: 15px;
        }

        header img.site-logo {
            height: 32px;
            width: auto;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        header h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.4em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        header p { color: var(--text-muted); font-size: 1.1em; }

        /* Cards */
        .journey, .sidebar, .explanation, .editor-area,
        .config-section, .quick-ref, .webhook-tester {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .journey {
            padding: 20px 25px;
            margin-bottom: 15px;
        }

        .journey h2 {
            color: var(--teal);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .journey-steps {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .step {
            flex: 1;
            min-width: 180px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 14px 14px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .step:hover {
            transform: translateY(-8px);
            border-color: rgba(0,185,183,0.4);
            box-shadow: 0 12px 30px rgba(0,185,183,0.1);
        }

        .step.active {
            background: rgba(0,185,183,0.08);
            border-color: var(--teal);
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0,185,183,0.15);
        }

        .step-number {
            background: var(--gradient);
            color: white;
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
            font-size: 0.95em;
            box-shadow: 0 4px 12px rgba(0,185,183,0.3);
        }

        .step h3 { color: var(--text); font-size: 1.05em; margin-bottom: 8px; font-weight: 600; }
        .step p { color: var(--text-muted); font-size: 0.88em; }

        .step-arrow {
            position: absolute;
            right: -20px; top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-size: 1.5em;
            font-weight: bold;
        }

        .step:last-child .step-arrow { display: none; }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 25px;
        }

        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }

        /* Sidebar */
        .sidebar { padding: 25px; height: fit-content; }

        .sidebar h3 {
            color: var(--teal);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 1.1em;
        }

        .query-list { list-style: none; }
        .query-list li { margin-bottom: 10px; }

        .query-btn {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-family: inherit;
        }

        .query-btn:hover {
            background: rgba(0,185,183,0.06);
            border-color: var(--hover-border);
            transform: translateX(4px);
        }

        .query-btn.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(0,185,183,0.25);
        }

        .query-btn small { display: block; color: var(--text-dim); font-size: 0.8em; margin-top: 4px; font-weight: 400; }
        .query-btn.active small { color: rgba(255,255,255,0.8); }

        /* Explanation Panel */
        .explanation { padding: 16px 25px; margin-bottom: 15px; }
        .explanation-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        .explanation h3 { color: var(--teal); font-weight: 600; margin: 0; }
        .explanation-toggle { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); cursor: pointer; padding: 4px 10px; font-size: 0.8em; transition: all 0.2s; }
        .explanation-toggle:hover { border-color: var(--teal); color: var(--teal); }
        .explanation-content { margin-top: 16px; }
        .explanation-content.collapsed { display: none; }

        .explanation-content { color: var(--text-muted); }
        .explanation-content h4 { color: var(--text); margin: 18px 0 10px; font-weight: 600; }
        .explanation-content ul { list-style: none !important; padding-left: 0 !important; margin-left: 0; margin-bottom: 15px; }
        .explanation-content li { list-style: none !important; margin-bottom: 6px; color: var(--text-muted); padding-left: 16px; position: relative; }
        .explanation-content li::before { content: '‚Äì'; position: absolute; left: 0; color: var(--teal); font-weight: 600; }

        .analogy {
            background: rgba(49,34,246,0.12);
            border-left: 3px solid var(--purple);
            padding: 18px;
            margin: 18px 0;
            border-radius: 0 12px 12px 0;
        }

        .analogy strong { color: #a78bfa; }

        /* Editor Area */
        .editor-area { overflow: hidden; }

        .editor-header {
            background: rgba(255,255,255,0.04);
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .editor-header h3 { color: var(--text); font-weight: 600; }

        .run-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,185,183,0.25);
            font-family: inherit;
        }

        .run-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,185,183,0.35); }
        .run-btn:disabled { background: rgba(255,255,255,0.15); box-shadow: none; cursor: not-allowed; transform: none; }

        /* Vision Upload Panel */
        .vision-panel {
            display: none;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,185,183,0.03);
        }
        .vision-panel.visible { display: block; }
        .vision-drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 28px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            font-size: 0.9em;
        }
        .vision-drop-zone:hover, .vision-drop-zone.dragover {
            border-color: var(--teal);
            background: rgba(0,185,183,0.05);
            color: var(--teal);
        }
        .vision-drop-zone input[type=file] { display: none; }
        .vision-preview {
            display: none;
            align-items: center;
            gap: 16px;
            padding: 10px 0 4px;
        }
        .vision-preview.visible { display: flex; }
        .vision-preview img {
            width: 80px; height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .vision-preview-info { flex: 1; }
        .vision-preview-info .vision-filename { color: var(--text); font-size: 0.9em; font-weight: 500; }
        .vision-preview-info .vision-status { color: var(--teal); font-size: 0.8em; margin-top: 4px; }
        .vision-remove-btn {
            background: none; border: 1px solid var(--border); border-radius: 6px;
            color: var(--text-muted); cursor: pointer; padding: 4px 10px; font-size: 0.8em;
            transition: all 0.2s;
        }
        .vision-remove-btn:hover { border-color: #f87171; color: #f87171; }

        .editor-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 650px;
        }

        @media (max-width: 1100px) { .editor-body { grid-template-columns: 1fr; } }

        .editor-pane { border-right: 1px solid var(--border); }
        .editor-pane:last-child { border-right: none; }

        .pane-header {
            background: rgba(255,255,255,0.03);
            padding: 12px 18px;
            font-size: 0.8em;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        textarea {
            width: 100%;
            height: 650px;
            background: rgba(255,255,255,0.02);
            border: none;
            color: #7dd3fc;
            font-family: 'Monaco', 'Menlo', 'Fira Code', monospace;
            font-size: 13px;
            padding: 18px;
            resize: none;
        }

        textarea:focus { outline: none; background: rgba(0,185,183,0.03); }

        .response-area {
            padding: 18px;
            background: rgba(255,255,255,0.02);
            height: 650px;
            overflow: auto;
            font-family: 'Monaco', 'Menlo', 'Fira Code', monospace;
            font-size: 13px;
        }

        .response-area pre { white-space: pre-wrap; word-wrap: break-word; }
        .response-success { color: var(--teal); }
        .response-error { color: #f87171; }

        /* Config Section */
        .config-section { padding: 25px; margin-top: 20px; }
        .config-section h3 { color: var(--teal); margin-bottom: 18px; font-weight: 600; }

        .config-row { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
        .config-row label { min-width: 100px; color: var(--text-muted); font-weight: 500; }

        .config-row input {
            flex: 1;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: monospace;
            transition: all 0.2s ease;
        }

        .config-row input:focus {
            outline: none;
            border-color: rgba(0,185,183,0.5);
            box-shadow: 0 0 0 3px rgba(0,185,183,0.1);
        }

        /* Quick Reference */
        .quick-ref { padding: 30px; margin-top: 25px; }
        .quick-ref h3 { color: var(--teal); margin-bottom: 20px; font-weight: 600; font-size: 1.2em; }

        .ref-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; }

        .ref-card {
            background: rgba(255,255,255,0.03);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .ref-card:hover {
            transform: translateY(-4px);
            border-color: var(--hover-border);
            box-shadow: 0 8px 25px rgba(0,185,183,0.1);
        }

        .ref-card h4 { color: var(--teal); margin-bottom: 10px; font-size: 0.95em; font-weight: 600; }
        .ref-card p { color: var(--text-muted); font-size: 0.88em; margin-bottom: 6px; }

        .ref-card code {
            background: rgba(0,185,183,0.12);
            padding: 3px 8px;
            border-radius: 6px;
            color: var(--teal);
            font-size: 0.85em;
            font-weight: 500;
        }

        /* Friendly View */
        .friendly-view {
            background: rgba(0,185,183,0.06);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(0,185,183,0.25);
            display: none;
        }

        .friendly-view.visible { display: block; }
        .friendly-view h3 { color: var(--teal); margin-bottom: 20px; font-size: 1.15em; font-weight: 600; }

        .friendly-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 800px) { .friendly-grid { grid-template-columns: 1fr; } }

        .friendly-section {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .friendly-section h4 {
            color: var(--text-muted);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .friendly-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .friendly-row:last-child { border-bottom: none; }
        .friendly-label { color: var(--text-muted); font-size: 0.92em; }
        .friendly-value { color: var(--text); font-weight: 600; font-size: 0.92em; }
        .friendly-value.money { color: var(--teal); }

        .friendly-total {
            background: rgba(0,185,183,0.1);
            padding: 15px 18px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0,185,183,0.25);
        }

        .friendly-total .friendly-label { color: var(--teal); font-weight: 600; }
        .friendly-total .friendly-value { font-size: 1.15em; color: var(--teal); }

        .friendly-copybox {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 20px;
            margin-top: 20px;
            border: 1px dashed rgba(0,185,183,0.4);
            display: none;
        }

        .friendly-copybox.visible { display: block; }

        .friendly-copybox h4 {
            color: var(--teal);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .friendly-copybox p { color: var(--text-muted); font-size: 0.85em; margin-bottom: 12px; }
        .friendly-copybox .copy-row { display: flex; align-items: center; gap: 10px; }

        .friendly-copybox .copy-id {
            flex: 1;
            background: rgba(0,185,183,0.08);
            border: 1px solid rgba(0,185,183,0.3);
            border-radius: 8px;
            padding: 12px 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--teal);
            font-weight: 600;
            word-break: break-all;
        }

        .friendly-copybox .copy-btn, .webhook-url-row .copy-btn {
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .friendly-copybox .copy-btn:hover, .webhook-url-row .copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,185,183,0.3);
        }

        .friendly-copybox .copy-btn.copied, .webhook-url-row .copy-btn.copied {
            background: linear-gradient(135deg, #00B9B7 0%, #047857 100%);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Status indicator */
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            margin-left: 12px;
            font-weight: 600;
        }

        .status.connected { background: rgba(0,185,183,0.15); color: var(--teal); border: 1px solid rgba(0,185,183,0.3); }
        .status.disconnected { background: rgba(248,113,113,0.12); color: #f87171; border: 1px solid rgba(248,113,113,0.3); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,185,183,0.4); }

        /* Webhook Tester */
        .webhook-tester { padding: 25px; display: none; }
        .webhook-tester.visible { display: block; }
        .webhook-tester h3 { color: var(--teal); margin-bottom: 18px; font-weight: 600; }

        .webhook-url-box {
            background: rgba(49,34,246,0.1);
            border: 1px solid rgba(49,34,246,0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .webhook-url-box label {
            display: block;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .webhook-url-row { display: flex; align-items: center; gap: 10px; }

        .webhook-url-row code {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(49,34,246,0.3);
            border-radius: 8px;
            padding: 10px 14px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
            color: #a78bfa;
            word-break: break-all;
        }

        .webhook-url-row .copy-btn { padding: 10px 18px; }

        .webhook-instructions {
            background: rgba(0,185,183,0.07);
            border: 1px solid rgba(0,185,183,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .webhook-instructions strong { color: var(--teal); }

        .webhook-instructions code {
            background: rgba(0,185,183,0.12);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            color: var(--teal);
        }

        .webhook-instructions ol { margin: 10px 0 0 20px; }
        .webhook-instructions li { margin-bottom: 6px; }

        .webhook-event-list { list-style: none; }

        .webhook-event-list .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .webhook-event-list .empty-state .pulse-dot {
            display: inline-block;
            width: 10px; height: 10px;
            background: var(--teal);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        .webhook-event-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .webhook-event-item:hover { border-color: var(--hover-border); }

        .webhook-event-header { display: flex; align-items: center; padding: 14px 18px; cursor: pointer; gap: 12px; }

        .webhook-event-badge {
            background: var(--gradient);
            color: white;
            font-size: 0.75em;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .webhook-event-time { color: var(--text-dim); font-size: 0.8em; margin-left: auto; white-space: nowrap; }
        .webhook-event-toggle { color: var(--text-dim); font-size: 0.9em; transition: transform 0.2s; }
        .webhook-event-item.expanded .webhook-event-toggle { transform: rotate(90deg); }

        .webhook-event-body { display: none; padding: 0 18px 14px; border-top: 1px solid var(--border); }
        .webhook-event-item.expanded .webhook-event-body { display: block; }

        .webhook-event-body pre {
            background: rgba(0,0,0,0.4);
            color: #a78bfa;
            border-radius: 8px;
            padding: 14px;
            font-size: 0.8em;
            overflow-x: auto;
            margin-top: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .webhook-polling-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            color: var(--text-dim);
            margin-bottom: 15px;
        }

        .webhook-polling-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--teal);
            animation: pulse 2s ease-in-out infinite;
        }

        .webhook-clear-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 0.8em;
            color: var(--text-muted);
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .webhook-clear-btn:hover { border-color: #f87171; color: #f87171; }
    </style>
</head>
<body>

    <!-- Access Gate -->
    <div id="accessGate" style="display:none; position:fixed; inset:0; z-index:9999; background:#0c0c14; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; overflow:hidden; align-items:center; justify-content:center;">
        <!-- Background cipher watermark -->
        <img src="/cipher.png" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:80vmin; opacity:0.04; pointer-events:none; user-select:none;" alt="">
        <!-- Gradient orbs for depth -->
        <div style="position:absolute; top:-20%; left:-10%; width:60vw; height:60vw; background:radial-gradient(circle, rgba(0,185,183,0.15) 0%, transparent 70%); border-radius:50%; pointer-events:none;"></div>
        <div style="position:absolute; bottom:-20%; right:-10%; width:60vw; height:60vw; background:radial-gradient(circle, rgba(49,34,246,0.18) 0%, transparent 70%); border-radius:50%; pointer-events:none;"></div>

        <!-- Card -->
        <div style="position:relative; z-index:1; background:rgba(255,255,255,0.04); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.08); border-radius:20px; padding:48px 40px 40px; width:calc(100% - 32px); max-width:400px; display:flex; flex-direction:column; align-items:center; gap:28px;">

                <!-- Logo -->
                <img src="/zonos-logo.png" style="height:36px; width:auto; object-fit:contain;" alt="Zonos">

                <!-- Divider -->
                <div style="width:40px; height:2px; background:linear-gradient(90deg,#00B9B7,#3122F6); border-radius:2px;"></div>

                <!-- Text -->
                <div style="text-align:center; display:flex; flex-direction:column; gap:8px;">
                    <h1 style="color:#ffffff; font-size:1.4em; font-weight:700; margin:0; letter-spacing:-0.02em;">API Playground</h1>
                    <p style="color:rgba(255,255,255,0.5); font-size:0.9em; margin:0; line-height:1.5;">Enter your access code to continue</p>
                </div>

                <!-- Input & Button -->
                <div style="display:flex; flex-direction:column; gap:12px; width:100%;">
                    <input id="accessCodeInput" type="password" placeholder="Access code" autocomplete="off"
                        style="width:100%; padding:14px 18px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.06); color:#fff; font-size:1em; outline:none; text-align:center; letter-spacing:3px; transition:border-color 0.2s; box-sizing:border-box; font-family:inherit;"
                        onfocus="this.style.borderColor='rgba(0,185,183,0.6)'" onblur="this.style.borderColor='rgba(255,255,255,0.12)'"
                        onkeydown="if(event.key==='Enter') checkAccessCode()">
                    <button onclick="checkAccessCode()"
                        style="width:100%; padding:14px; border-radius:12px; background:linear-gradient(135deg,#00B9B7 0%,#3122F6 100%); color:#fff; font-size:0.95em; font-weight:600; border:none; cursor:pointer; letter-spacing:0.02em; transition:opacity 0.2s; font-family:inherit;"
                        onmouseover="this.style.opacity='0.88'" onmouseout="this.style.opacity='1'">
                        Continue
                    </button>
                    <p id="accessError" style="color:#ff6b6b; font-size:0.83em; text-align:center; min-height:1.2em; margin:0;"></p>
                </div>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
    <div class="container">
        <header>
            <img src="/zonos-logo.png" class="site-logo" alt="Zonos">
            <h1>API Playground</h1>
            <p>Understand how the Zonos APIs work.</p>
        </header>

        <!-- The Merchant Journey -->
        <section class="journey">
            <h2>The Merchant Journey: How Zonos Works</h2>
            <div class="journey-steps">
                <div class="step" onclick="showStep(1)">
                    <div class="step-number">1</div>
                    <h3>Calculate Landed Cost</h3>
                    <p>Zonos calculates duties, taxes & fees</p>
                    <span class="step-arrow">&rarr;</span>
                </div>
                <div class="step" onclick="showStep(2)">
                    <div class="step-number">2</div>
                    <h3>Customer Pays</h3>
                    <p>Total includes all import costs</p>
                    <span class="step-arrow">&rarr;</span>
                </div>
                <div class="step" onclick="showStep(3)">
                    <div class="step-number">3</div>
                    <h3>Create Order</h3>
                    <p>Merchant sends order to Zonos</p>
                    <span class="step-arrow">&rarr;</span>
                </div>
                <div class="step" onclick="showStep(4)">
                    <div class="step-number">4</div>
                    <h3>Ship & Track</h3>
                    <p>Add tracking, Zonos handles customs</p>
                </div>
            </div>
        </section>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Sidebar with queries -->
            <aside class="sidebar">
                <h3>Landed Cost APIs Order</h3>
                <ul class="query-list">
                    <li>
                        <button class="query-btn" onclick="loadQuery('landed-cost')">
                            Calculate Landed Cost
                            <small>What duties/taxes will customer pay?</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('create-order')">
                            Create an Order
                            <small>Record the sale in Zonos</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('add-tracking')">
                            Add Tracking Number
                            <small>Update order with shipment info</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('void-shipment')">
                            Void Shipment
                            <small>Void a label/tracking to allow cancellation</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('cancel-order')">
                            Cancel an Order
                            <small>Cancel an order after voiding shipment</small>
                        </button>
                    </li>
                </ul>

                <h3 style="margin-top: 30px;">Other APIs</h3>
                <ul class="query-list">
                    <li>
                        <button class="query-btn" onclick="loadQuery('classify')">
                            Classify Item
                            <small>Get HS code for a product</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('country-of-origin')">
                            Country of Origin
                            <small>Predict where a product was made</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('customs-value')">
                            Customs Value
                            <small>Estimate fair market value of a product</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('restrictions')">
                            Item Restrictions
                            <small>Check if an item can be shipped</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('screen')">
                            Screen Parties
                            <small>Check names against denied party lists</small>
                        </button>
                    </li>
                    <li>
                        <button class="query-btn" onclick="loadQuery('vision')">
                            Vision
                            <small>Extract item details from a photo</small>
                        </button>
                    </li>
                </ul>

                <h3 style="margin-top: 30px;">Webhooks</h3>
                <ul class="query-list">
                    <li>
                        <button class="query-btn" id="webhookTesterBtn" onclick="showWebhookView()">
                            Webhooks
                            <small>Learn &amp; see live webhook events</small>
                        </button>
                    </li>
                </ul>
            </aside>

            <!-- Right side content -->
            <div class="right-content">
                <!-- Explanation Panel -->
                <div class="explanation" id="explanation">
                    <div class="explanation-header" onclick="toggleExplanation()">
                        <h3 id="explanationTitle">Select an API from the left to get started</h3>
                        <button class="explanation-toggle" id="explanationToggle">Hide ‚ñ≤</button>
                    </div>
                    <div class="explanation-content" id="explanationContent">
                        <p>This tool helps you understand how merchants use the Zonos API. Each button on the left shows you:</p>
                        <ul>
                            <li><strong>What it does</strong> - in plain English</li>
                            <li><strong>When merchants use it</strong> - the real-world scenario</li>
                            <li><strong>The actual API code</strong> - what gets sent to Zonos</li>
                        </ul>
                        <div class="analogy">
                            <strong>Think of it like a restaurant:</strong> The customer (API) sends an order to the kitchen (Zonos), the kitchen prepares it and sends back the result. Webhooks are like the waiter coming to tell you "your food is ready!"
                        </div>
                    </div>
                </div>

                <!-- Editor Area -->
                <div class="editor-area">
                    <div class="editor-header">
                        <h3>GraphQL Playground <span class="status connected" id="status">Ready</span></h3>
                        <button class="run-btn" id="runBtn" onclick="runQuery()">Run Query</button>
                    </div>
                    <!-- Vision Image Upload Panel (shown only for Vision API) -->
                    <div class="vision-panel" id="visionPanel">
                        <div class="vision-drop-zone" id="visionDropZone" onclick="document.getElementById('visionFileInput').click()" ondragover="event.preventDefault(); this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleVisionDrop(event)">
                            <input type="file" id="visionFileInput" accept="image/jpeg,image/png,image/heic" onchange="handleVisionFile(this.files[0])">
                            <div style="font-size: 1.8em; margin-bottom: 8px;">üì∑</div>
                            <strong style="color: var(--text);">Drop an image here or click to upload</strong>
                            <div style="margin-top: 6px; font-size: 0.85em;">JPEG, PNG, or HEIC &mdash; Zonos AI will identify items, HS codes, and estimated values</div>
                        </div>
                        <div class="vision-preview" id="visionPreview">
                            <img id="visionPreviewImg" src="" alt="Preview">
                            <div class="vision-preview-info">
                                <div class="vision-filename" id="visionFilename"></div>
                                <div class="vision-status">Image ready &mdash; click Run Query to analyze</div>
                            </div>
                            <button class="vision-remove-btn" onclick="clearVisionImage()">Remove</button>
                        </div>
                    </div>

                    <div class="editor-body">
                        <div class="editor-pane">
                            <div class="pane-header">QUERY (editable - modify values before running)</div>
                            <textarea id="queryEditor" placeholder="Select a query from the left, or use this space to paste a query or create your own."></textarea>
                        </div>
                        <div class="editor-pane">
                            <div class="pane-header">RESPONSE (what Zonos sends back)</div>
                            <div class="response-area" id="responseArea">
                                <pre>Response will appear here after you run a query...</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friendly View Section -->
                <div class="friendly-view" id="friendlyView">
                    <h3>Results Summary</h3>
                    <div class="friendly-grid" id="friendlyGrid">
                        <div class="friendly-section" id="friendlyInput">
                            <h4>What Was Sent</h4>
                            <div id="friendlyInputContent">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        <div class="friendly-section" id="friendlyOutput">
                            <h4>What Came Back</h4>
                            <div id="friendlyOutputContent">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="friendly-section" id="friendlyStatus" style="display: none;">
                        <div id="friendlyStatusContent"></div>
                    </div>
                    <div class="friendly-copybox" id="friendlyCopyBox">
                        <h4>Use This in Create Order</h4>
                        <p>Copy this Landed Cost ID and paste it into the "Create an Order" mutation as the <code>landedCostId</code> value.</p>
                        <div class="copy-row">
                            <span class="copy-id" id="landedCostIdValue"></span>
                            <button class="copy-btn" onclick="copyCopyBox('landedCostIdValue', this)">Copy ID</button>
                        </div>
                    </div>
                    <div class="friendly-copybox" id="orderIdCopyBox">
                        <h4>Use This in Add Tracking Number</h4>
                        <p>Copy this Order ID and paste it into the "Add Tracking Number" mutation as the <code>orderId</code> value.</p>
                        <div class="copy-row">
                            <span class="copy-id" id="orderIdValue"></span>
                            <button class="copy-btn" onclick="copyCopyBox('orderIdValue', this)">Copy ID</button>
                        </div>
                    </div>
                    <div class="friendly-copybox" id="shipmentIdCopyBox">
                        <h4>Use This in Void Shipment</h4>
                        <p>Copy this Shipment ID and paste it into the "Void Shipment" mutation as the <code>shipment</code> value.</p>
                        <div class="copy-row">
                            <span class="copy-id" id="shipmentIdValue"></span>
                            <button class="copy-btn" onclick="copyCopyBox('shipmentIdValue', this)">Copy ID</button>
                        </div>
                    </div>
                </div>

                <!-- Webhook Tester Panel -->
                <div class="webhook-tester" id="webhookTester">
                    <h3>Merchant's Webhook Inbox</h3>

                    <div class="webhook-instructions" style="background: linear-gradient(135deg, rgba(0,185,183,0.12) 0%, rgba(49,34,246,0.12) 100%); border-color: rgba(0,185,183,0.3); color: var(--text);">
                        <strong style="color: var(--teal);">Try it live:</strong> Go run an API mutation on the left (Create an Order, Add Tracking, or Cancel an Order), then come back here. You'll see the webhook event that Zonos would send to the merchant's server &mdash; with the real data from your API call.
                    </div>


                    <div class="webhook-polling-status">
                        <span class="webhook-polling-dot"></span>
                        <span>Listening for events...</span>
                        <button class="webhook-clear-btn" onclick="clearWebhookEvents()">Clear Events</button>
                    </div>

                    <ul class="webhook-event-list" id="webhookEventList">
                        <li class="empty-state">
                            <span class="pulse-dot"></span>
                            Waiting for webhook events...<br>
                            <small>Events will appear here automatically when received</small>
                        </li>
                    </ul>
                </div>

                <!-- Config Section -->
                <div class="config-section">
                    <h3>API Settings</h3>
                    <div id="serverKeyStatus" style="display: none; padding: 12px 16px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 10px; border: 1px solid #a7f3d0; margin-bottom: 15px;">
                        <span style="color: #047857; font-weight: 600;">Server API key is active</span>
                        <span style="color: #6b7280; font-size: 0.85em; margin-left: 8px;">- no setup needed, just run queries</span>
                    </div>
                    <div class="config-row">
                        <label>Endpoint:</label>
                        <input type="text" id="endpoint" value="https://api.zonos.com/graphql" onchange="saveConfig()">
                    </div>
                    <input type="hidden" id="apiKey" value="">
                </div>
            </div>
        </div>

    </div>
    </div><!-- end mainApp -->

    <script>
        // Query templates with explanations
        const queries = {
            'landed-cost': {
                title: 'Calculate Landed Cost',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>This calculates the <strong>total cost</strong> for an international customer to receive their order, including:</p>
                    <ul>
                        <li><strong>Duties</strong> - Import taxes based on product type and origin country</li>
                        <li><strong>Taxes</strong> - VAT, GST, or sales tax depending on destination</li>
                        <li><strong>Fees</strong> - Customs processing, handling fees</li>
                    </ul>

                    <h4>When do merchants use this?</h4>
                    <p>At checkout, when an international customer enters their shipping address. The merchant's website calls this API to show the customer exactly what they'll pay - no surprise fees at delivery!</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like getting a quote from a moving company. Before you commit, they tell you exactly what it will cost including all fees. Zonos does this for international shipping costs.
                    </div>

                    <h4>Key inputs needed:</h4>
                    <ul>
                        <li>Ship-from address (merchant's warehouse)</li>
                        <li>Ship-to address (customer's location)</li>
                        <li>Items in cart (description, price, quantity, country of origin)</li>
                    </ul>
                `,
                query: `# Calculate Landed Cost
# This mutation calculates duties, taxes, and fees for an international order
# Each workflow step builds on the previous one

mutation CalculateLandedCost {
  # Step 1: Create the parties (shipper and recipient)
  partyCreateWorkflow(input: [
    {
      type: ORIGIN
      location: {
        line1: "123 Main Street"
        locality: "St. George"
        administrativeAreaCode: "UT"
        postalCode: "84770"
        countryCode: US
      }
    },
    {
      type: DESTINATION
      person: {
        firstName: "Claude"
        lastName: "Code"
      }
      location: {
        line1: "456 Queen Street"
        locality: "Toronto"
        administrativeAreaCode: "ON"
        postalCode: "M5V3A8"
        countryCode: CA
      }
    }
  ]) {
    id
    type
  }

  # Step 2: Create the items being shipped
  itemCreateWorkflow(input: [
    {
      name: "Men's Athletic T-Shirt"
      description: "100% organic cotton, moisture-wicking, crew neck athletic fit t-shirt"
      amount: 99.99
      currencyCode: USD
      quantity: 2
      countryOfOrigin: BR
      hsCode: "6109.10"
      measurements: [
        { type: WEIGHT, value: 0.5, unitOfMeasure: POUND }
        { type: WIDTH, value: 0.5, unitOfMeasure: INCH }
        { type: HEIGHT, value: 0.5, unitOfMeasure: INCH }
        { type: LENGTH, value: 0.5, unitOfMeasure: INCH }
      ]
    }
  ]) {
    id
    description
    amount
  }

  # Step 3: Auto-sort items into cartons (required before shipping)
  cartonizeWorkflow {
    id
    type
    items {
      item {
        id
      }
    }
  }

  # Step 4: Set shipping rate (manual rate - you know the cost already)
  shipmentRatingCreateWorkflow(input: {
    amount: "25.00"
    currencyCode: USD
    serviceLevelCode: "ups.worldwide_expedited"
  }) {
    id
    amount
  }

  # Step 5: Calculate landed cost (duties, taxes, fees)
  landedCostCalculateWorkflow(input: {
    calculationMethod: DDP_PREFERRED
    endUse: NOT_FOR_RESALE
    tariffRate: ZONOS_PREFERRED
  }) {
    id
    method

    # Duties (import taxes)
    duties {
      amount
      currency
      note
    }

    # Taxes (VAT, GST, etc.)
    taxes {
      amount
      currency
      note
    }

    # Fees (processing, handling)
    fees {
      amount
      currency
      note
    }
  }
}`
            },

            'create-order': {
                title: 'Create an Order',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>Records a completed sale in Zonos. This connects the landed cost quote to an actual order so Zonos can:</p>
                    <ul>
                        <li>Track the order through fulfillment</li>
                        <li>Bill the merchant for duties/taxes collected</li>
                        <li>Handle customs paperwork when shipped</li>
                    </ul>

                    <h4>When do merchants use this?</h4>
                    <p>Immediately after a customer completes checkout and payment is confirmed. The merchant's system sends this to "register" the order with Zonos.</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like registering a car purchase. The sale happened, now you need to file the paperwork so everything is official and tracked.
                    </div>

                    <h4>Important notes:</h4>
                    <ul>
                        <li>The <code>landedCostId</code> comes from the previous calculation</li>
                        <li>Landed cost quotes expire after 90 days</li>
                    </ul>
                `,
                query: `# Create an Order in Zonos
# Call this AFTER the customer completes payment
#
# ‚ö†Ô∏è STEP 1: Run "Calculate Landed Cost" first!
# STEP 2: Copy the "id" from that response
# STEP 3: Paste it below as the landedCostId
# STEP 4: Then run this mutation

mutation CreateOrder {
  orderCreate(input: {
    # Your order number (from Shopify, WooCommerce, etc.)
    accountOrderNumber: "ORD-2024-12345"

    # The currency customer paid in
    currencyCode: USD

    # ‚¨áÔ∏è PASTE YOUR LANDED COST ID HERE (from Calculate Landed Cost response)
    landedCostId: "PASTE_YOUR_LANDED_COST_ID_HERE"
  }) {
    # What Zonos sends back
    id                    # Zonos order ID (save this!)
    accountOrderNumber    # Your order number echoed back
    status               # Should be "OPEN"
    amountSubtotals {
      duties
      taxes
      fees
      shipping
      items
    }
  }
}`
            },

            'add-tracking': {
                title: 'Add Tracking Number',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>Updates an order with shipping information. This is crucial because:</p>
                    <ul>
                        <li>Tells Zonos the package is on its way</li>
                        <li>Triggers duty/tax payment to customs</li>
                        <li>Updates order status to "Fulfilled"</li>
                    </ul>

                    <h4>When do merchants use this?</h4>
                    <p>After the merchant ships the package and has a tracking number from the carrier (UPS, FedEx, DHL, etc.).</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like telling the post office "here's my package, here's where it's going, and here's the tracking number." Now everyone can follow its journey.
                    </div>

                `,
                query: `# Add Tracking Number to an Order
# Call this AFTER you ship the package
#
# ‚ö†Ô∏è STEP 1: Run "Create an Order" first!
# STEP 2: Copy the "id" from that response
# STEP 3: Paste it below as the orderId
# STEP 4: Then run this mutation

mutation AddTracking {
  shipmentCreateWorkflow(input: {
    # ‚¨áÔ∏è PASTE YOUR ORDER ID HERE (from Create Order response)
    orderId: "PASTE_YOUR_ORDER_ID_HERE"

    # The tracking number from your carrier
    trackingNumbers: ["1Z999AA10123456784"]

    # Set to false if you're using your own labels
    # Set to true if you want Zonos to generate labels
    generateLabel: false
  }) {
    id
    status
    trackingDetails {
      number
    }
    serviceLevel {
      name
      carrier {
        name
      }
    }
  }
}

# Alternative: The older mutation some docs reference
# mutation OldStyle {
#   shipmentCreateWithTracking(input: {
#     orderId: "order_abc123"
#     tracking: [{ number: "1Z999AA10123456784", type: SHIPMENT }]
#   }) {
#     id
#   }
# }`
            },

            'cancel-order': {
                title: 'Cancel an Order',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>Cancels an order in Zonos. This is important for:</p>
                    <ul>
                        <li>Customer refund requests</li>
                        <li>Avoiding being billed for duties/taxes</li>
                    </ul>

                    <h4>When do merchants use this?</h4>
                    <p>Before the order ships.</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> Like cancelling a restaurant order before the kitchen starts cooking. Easy to do early, complicated once the food is being prepared.
                    </div>

                    <h4>What happens when cancelled:</h4>
                    <ul>
                        <li>Order status changes to "CANCELLED"</li>
                        <li>No duties/taxes are charged</li>
                        <li>Merchant isn't billed for Zonos fees on cancelled orders</li>
                    </ul>
                `,
                query: `# Cancel an Order
# Use this BEFORE the order ships
#
# ‚ö†Ô∏è Paste a real Order ID below before running

mutation CancelOrder {
  orderCancel(input: {
    # ‚¨áÔ∏è PASTE YOUR ORDER ID HERE
    id: "PASTE_YOUR_ORDER_ID_HERE"

    # Why are you cancelling? (optional but helpful)
    note: "Customer requested cancellation"
  }) {
    id
    status          # Should now be "CANCELLED"
    updatedAt       # Timestamp of the update
  }
}`
            },

            'void-shipment': {
                title: 'Void Shipment',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>Voids a shipment and its associated labels. This is needed when:</p>
                    <ul>
                        <li>You need to cancel an order that already has tracking</li>
                        <li>A label was created by mistake</li>
                        <li>The shipment details need to be corrected</li>
                    </ul>

                    <h4>When do merchants use this?</h4>
                    <p>Before cancelling an order that has had tracking added. You must void the shipment first, then cancel the order.</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> Like telling the post office "never mind, don't ship that package" before it leaves the warehouse. Once voided, you can then cancel the order itself.
                    </div>

                    <h4>Important:</h4>
                    <ul>
                        <li>Once voided, the shipment cannot be restored</li>
                        <li>All labels tied to the shipment are also voided</li>
                        <li>After voiding, run "Cancel an Order" to complete the cancellation</li>
                    </ul>
                `,
                query: `# Void a Shipment
# Use this to void a label/tracking BEFORE cancelling the order
#
# ‚ö†Ô∏è STEP 1: Get the shipment ID from the Add Tracking response
# STEP 2: Paste it below
# STEP 3: Run this mutation
# STEP 4: Then run "Cancel an Order"

mutation VoidShipment {
  shipmentStatusUpdate(input: {
    # ‚¨áÔ∏è PASTE YOUR SHIPMENT ID HERE (from Add Tracking response)
    shipment: "PASTE_YOUR_SHIPMENT_ID_HERE"

    status: VOIDED

    # Why are you voiding? (optional but helpful)
    note: "Voiding shipment to cancel order"
  }) {
    id
    status
  }
}`
            },

        'classify': {
                title: 'Classify Item',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>This looks up the <strong>HS code</strong> (Harmonized System code) for a product. HS codes are the international standard used by customs authorities worldwide to identify and categorize goods for duties and taxes.</p>

                    <h4>Why does this matter?</h4>
                    <ul>
                        <li>Every item shipped internationally needs an HS code</li>
                        <li>The HS code determines the <strong>duty rate</strong> applied at customs</li>
                        <li>Wrong codes can cause customs delays or incorrect charges</li>
                        <li>Zonos uses the HS code in the landed cost calculation</li>
                    </ul>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> Think of HS codes like barcodes for international trade. Every product has one, and customs agents use it to instantly know what tax rate to apply ‚Äî just like a grocery store scanner knows a product's price from its barcode.
                    </div>

                    <h4>Key inputs:</h4>
                    <ul>
                        <li><strong>name</strong> (required) ‚Äî the product name</li>
                        <li><strong>description</strong> ‚Äî more detail = better accuracy</li>
                        <li><strong>imageUrl</strong> ‚Äî a direct link to the product image</li>
                        <li><strong>categories</strong> ‚Äî e.g. "women's clothing"</li>
                        <li><strong>shipToCountries</strong> ‚Äî include to get a country-specific code (8+ digits); omit for universal 6-digit code</li>
                    </ul>

                    <h4>What comes back?</h4>
                    <p>An HS code like <code>6116.99.0000</code> plus a full description of what that code covers. You can then use this HS code in your landed cost calculation.</p>
                `,
                query: `# Classify Item - Get HS Code
# Zonos uses AI to classify your product and return the correct HS code
# More detail = more accurate classification

mutation ClassifyItem {
  classificationsCalculate(input: [
    {
      # Required: product name
      name: "Men's Athletic T-Shirt"

      # Optional: more detail improves accuracy
      description: "100% organic cotton, moisture-wicking crew neck athletic fit t-shirt"

      # Optional: direct URL to product image (not the product page)
      imageUrl: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400"

      # Optional: general product category
      categories: "men's clothing"

      # Optional: include a destination country for country-specific codes (8+ digits)
      # Omit for a universal 6-digit HS code
      configuration: {
        shipToCountries: CA
      }
    }
  ]) {
    id
    name
    hsCode {
      code
      description {
        full
      }
    }
  }
}`
            },

        'country-of-origin': {
                title: 'Country of Origin',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>This predicts the <strong>country where a product was manufactured</strong>, using Zonos AI trained on tens of millions of anonymized customs declarations. It supports 200+ countries.</p>

                    <h4>Why does this matter?</h4>
                    <ul>
                        <li>Country of origin is <strong>required</strong> for international shipments and customs declarations</li>
                        <li>It directly affects the <strong>duty rate</strong> applied ‚Äî the same product made in China vs. the US can have very different duties</li>
                        <li>Merchants often don't know the exact origin of every SKU in their catalog</li>
                        <li>Zonos uses this as an input when calculating landed cost</li>
                    </ul>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like customs asking "where was this made?" ‚Äî a question that's often on the label, but not always in the merchant's system. Zonos predicts the answer based on the product details, brand, and historical customs data.
                    </div>

                    <h4>Key inputs:</h4>
                    <ul>
                        <li><strong>name</strong> (required) ‚Äî product name</li>
                        <li><strong>brand</strong> ‚Äî brand name significantly improves accuracy</li>
                        <li><strong>categories</strong> ‚Äî product category array</li>
                        <li><strong>description</strong> ‚Äî additional product detail</li>
                        <li><strong>material</strong> ‚Äî what the product is made of</li>
                        <li><strong>shipFromCountry</strong> ‚Äî where it ships from</li>
                        <li><strong>amount / currencyCode</strong> ‚Äî product price</li>
                    </ul>

                    <h4>What comes back?</h4>
                    <p>The predicted country code (e.g. <code>CN</code>) with a <strong>confidence score</strong> from 0‚Äì1, plus a list of alternate predictions with their probability.</p>
                `,
                query: `# Predict Country of Origin
# Zonos AI predicts where a product was manufactured
# Only "name" is required ‚Äî more fields = better accuracy

mutation PredictCountryOfOrigin {
  countryOfOriginInfer(input: [
    {
      # Required
      name: "Men's Athletic T-Shirt"

      # Optional ‚Äî each field improves accuracy
      brand: "Nike"
      categories: ["men's clothing", "sportswear"]
      description: "100% organic cotton, moisture-wicking crew neck athletic fit t-shirt"
      material: "cotton"
      shipFromCountry: US
      amount: 99.99
      currencyCode: USD
    }
  ]) {
    name
    brand
    countryOfOrigin
    confidenceScore
    alternates {
      countryOfOrigin
      probabilityMass
    }
  }
}`
            },

        'customs-value': {
                title: 'Customs Value',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>This estimates the <strong>fair market value</strong> of a product for customs purposes, using Zonos AI trained on real transaction data. It returns a point estimate and a confidence range.</p>

                    <h4>Why does this matter?</h4>
                    <ul>
                        <li>Customs authorities require an accurate declared value on every international shipment</li>
                        <li>Under-declaring value is a compliance risk ‚Äî over-declaring means higher duties for the customer</li>
                        <li>Useful for <strong>package forwarding</strong>, compliance checks, and broker reviews</li>
                        <li>Helps merchants who don't always know the retail price of every item they ship</li>
                    </ul>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like getting an appraisal before insuring something. You describe the item, and Zonos tells you what it's worth based on real market data ‚Äî so customs gets an accurate number.
                    </div>

                    <h4>Key inputs:</h4>
                    <ul>
                        <li><strong>name</strong> (required) ‚Äî product name</li>
                        <li><strong>currency</strong> (required) ‚Äî desired currency for the estimate</li>
                        <li><strong>brand</strong> ‚Äî improves accuracy significantly</li>
                        <li><strong>categories</strong> ‚Äî product category array</li>
                        <li><strong>description</strong> ‚Äî additional product detail</li>
                        <li><strong>material</strong> ‚Äî what the product is made of</li>
                    </ul>

                    <h4>What comes back?</h4>
                    <p>A <strong>point estimate</strong> (best guess value) plus a <strong>range</strong> with low and high bounds ‚Äî giving you a confidence band around the estimate.</p>
                `,
                query: `# Customs Value Estimation
# Zonos AI estimates the fair market value of a product for customs declarations
# "name" and "currency" are required ‚Äî more detail = better accuracy

mutation CustomsValue {
  valueEstimate(input: [
    {
      # Required
      name: "Apple AirPods Pro 2nd Generation"
      currency: USD

      # Optional ‚Äî each field improves accuracy
      brand: "Apple"
      categories: ["Electronics", "Headphones"]
      description: "Active noise cancelling wireless earbuds with MagSafe charging case"
      material: "plastic"
    }
  ]) {
    name
    brand
    currency
    value
    valueEstimateRange {
      low
      high
      width
    }
  }
}`
            },

        'restrictions': {
                title: 'Item Restrictions',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>This checks whether an item can be legally shipped between two countries, flagging any <strong>prohibitions, restrictions, or observations</strong> based on government regulations, carrier rules, and HS code data.</p>

                    <h4>The three levels:</h4>
                    <ul>
                        <li><strong>Prohibition</strong> ‚Äî Item cannot be shipped. Full stop.</li>
                        <li><strong>Restriction</strong> ‚Äî Item can ship but with conditions (permits, licenses, special handling)</li>
                        <li><strong>Observation</strong> ‚Äî Worth noting but no hard block</li>
                    </ul>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like a customs agent checking a list before letting a package through. Some items are flat-out banned, some need special paperwork, and some just get flagged for attention. Zonos checks all of this automatically using the item's HS code and route.
                    </div>

                    <h4>Key inputs:</h4>
                    <ul>
                        <li><strong>shipFromCountry</strong> (required) ‚Äî origin country</li>
                        <li><strong>shipToCountry</strong> (required) ‚Äî destination country</li>
                        <li><strong>items: hsCode</strong> (required) ‚Äî HS code for the item</li>
                        <li><strong>items: countryOfOrigin</strong> (required) ‚Äî where the item was made</li>
                        <li><strong>carrier</strong> ‚Äî optional, defaults to a universal catch-all</li>
                        <li><strong>restrictionTypeThreshold</strong> ‚Äî filter by severity: <code>PROHIBITION</code>, <code>RESTRICTION</code>, or <code>OBSERVATION</code></li>
                    </ul>

                    <h4>What comes back?</h4>
                    <p>An <strong>action</strong> for each item ‚Äî <code>NO_MATCH</code> (clear to ship), <code>RESTRICTIONS_APPLY</code>, or <code>PROHIBITIONS_APPLY</code> ‚Äî plus details on each rule that triggered.</p>
                `,
                query: `# Item Restrictions Check
# Checks if an item can be shipped between two countries based on HS code and regulations
# Returns NO_MATCH (clear), RESTRICTIONS_APPLY, or PROHIBITIONS_APPLY

mutation CheckRestrictions {
  itemRestrictionApply(input: {
    shipFromCountry: US
    shipToCountry: CA

    # PROHIBITION, RESTRICTION, or OBSERVATION (defaults to RESTRICTION)
    restrictionTypeThreshold: OBSERVATION

    # Optional ‚Äî defaults to "Other" (universal catch-all)
    carrier: DHL

    items: [
      {
        hsCode: "6109.10"      # Men's cotton t-shirt
        description: "Men's athletic cotton t-shirt"
        countryOfOrigin: US
      }
    ]
  }) {
    id
    shipFromCountry
    shipToCountry
    items {
      id
      action
      itemDescription
      itemHsCode
      itemRestrictions {
        type
        controlType
        controlSummary
        note
        sources
        appliesTo
      }
    }
  }
}`
            },

        'screen': {
                title: 'Screen Parties',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>This checks whether a person or company appears on any <strong>government-authored denied party lists</strong> before you ship to them. If a match is found, Zonos returns a <code>REVIEW</code> action, meaning you should not ship until you've verified compliance.</p>

                    <h4>Why does this matter?</h4>
                    <p>Shipping to a denied party can result in serious legal consequences ‚Äî heavy fines or criminal penalties. This is especially important for cross-border shipments where export control laws apply (e.g. US Office of Foreign Assets Control / OFAC lists).</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> It's like a bouncer checking a no-entry list at the door. Before the package leaves, Zonos checks the recipient's name and address against every government watchlist. If there's a match, you get flagged to review before proceeding.
                    </div>

                    <h4>Key inputs:</h4>
                    <ul>
                        <li><strong>person.firstName / lastName</strong> ‚Äî name of the individual being screened</li>
                        <li><strong>location.countryCode</strong> (required) ‚Äî destination country</li>
                        <li><strong>location.locality</strong> (required) ‚Äî city</li>
                        <li><strong>location.line1</strong> ‚Äî street address (improves match accuracy)</li>
                        <li><strong>location.administrativeAreaCode</strong> ‚Äî state/province code</li>
                        <li><strong>location.postalCode</strong> ‚Äî postal/ZIP code</li>
                    </ul>

                    <h4>What comes back?</h4>
                    <p>An <strong>action</strong> ‚Äî <code>NO_MATCHES</code> (safe to ship) or <code>REVIEW</code> (potential match found) ‚Äî plus details on each denied party match including name, location, and match scores (0.0‚Äì1.0).</p>
                `,
                query: `# Party Screening
# Checks a person or company against government denied party lists
# action: NO_MATCHES (clear to ship) or REVIEW (potential match ‚Äî do not ship until verified)

mutation ScreenParty {
  partyScreen(input: {
    person: {
      firstName: "John"
      lastName: "Smith"
    }
    location: {
      countryCode: US
      locality: "New York"
      administrativeAreaCode: "NY"
      postalCode: "10001"
      line1: "123 Main St"
    }
  }) {
    action
    id
    party {
      id
      organization
      person {
        firstName
        lastName
      }
    }
    matches {
      name
      companyName
      countryCode
      locality
      line1
      scores {
        location
        name
        overall
      }
    }
  }
}`
            },

        'vision': {
                title: 'Vision ‚Äî Extract Items from Photo',
                explanation: `
                    <h4>What does this do?</h4>
                    <p>Zonos Vision uses AI to <strong>look at a photo and automatically extract item details</strong> ‚Äî name, description, materials, HS code, and estimated customs value. No manual data entry required.</p>

                    <h4>What gets returned?</h4>
                    <ul>
                        <li><strong>Item name &amp; description</strong> ‚Äî AI-generated, ready for customs forms</li>
                        <li><strong>HS code</strong> ‚Äî automatically classified with a confidence score</li>
                        <li><strong>Estimated value</strong> ‚Äî with a high/low range for customs purposes</li>
                        <li><strong>Materials</strong> ‚Äî fabric, plastic, metal, etc.</li>
                        <li><strong>Multiple items</strong> ‚Äî Vision detects every item in a single photo</li>
                    </ul>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong> Imagine a customs agent who can look at a photo of your package contents and instantly know what everything is, what it's worth, and which HS code applies ‚Äî without you having to fill out a single form. That's Zonos Vision.
                    </div>

                    <h4>How to use:</h4>
                    <p>Upload a photo using the panel above the editor, then click <strong>Run Query</strong>. Zonos will analyze the image and return structured item data in 2‚Äì5 seconds.</p>

                    <h4>Configuration options:</h4>
                    <ul>
                        <li><strong>classify: ENABLED</strong> ‚Äî include HS code classification</li>
                        <li><strong>estimateValue: ENABLED</strong> ‚Äî include estimated customs value</li>
                        <li><strong>shipToCountry</strong> ‚Äî destination country (affects classification rules)</li>
                    </ul>
                `,
                query: `# Zonos Vision ‚Äî Upload an image above, then click Run Query
# AI extracts item name, description, HS code, and estimated value from photos
# Variables (imageBase64) are injected automatically from the uploaded image

mutation ItemsExtract($input: ItemsExtractInput!) {
  itemsExtract(input: $input) {
    id
    quantity
    content {
      name
      description
      materials
      language
    }
    classification {
      confidenceScore
      hsCode {
        code
      }
    }
    valueEstimation {
      currency
      value
      valueEstimateRange {
        high
        low
      }
    }
  }
}`
            },

        };

        // Load config from localStorage, then try server-side key
        function loadConfig() {
            const apiKey = localStorage.getItem('zonos_api_key');
            const endpoint = localStorage.getItem('zonos_endpoint');

            if (apiKey) document.getElementById('apiKey').value = apiKey;
            if (endpoint) document.getElementById('endpoint').value = endpoint;

            // Check if server has an API key configured
            fetch('/proxy')
                .then(r => r.json())
                .then(data => {
                    if (data.hasKey) {
                        document.getElementById('serverKeyStatus').style.display = '';
                        updateStatus();
                    }
                })
                .catch(() => {});

            updateStatus();
        }

        // Save config to localStorage
        function saveConfig() {
            localStorage.setItem('zonos_api_key', document.getElementById('apiKey').value);
            localStorage.setItem('zonos_endpoint', document.getElementById('endpoint').value);
            updateStatus();
        }

        // Update connection status
        function updateStatus() {
            const status = document.getElementById('status');
            const apiKey = document.getElementById('apiKey').value;

            if (apiKey && apiKey.startsWith('credential_')) {
                status.textContent = 'Ready (Local Key)';
                status.className = 'status connected';
            } else {
                status.textContent = 'Ready';
                status.className = 'status connected';
            }
        }

        // Load a query template
        function loadQuery(queryId) {
            const query = queries[queryId];
            if (!query) return;

            // Hide webhook tester if visible
            hideWebhookTester();

            // Show/hide vision upload panel
            const visionPanel = document.getElementById('visionPanel');
            if (queryId === 'vision') {
                visionPanel.classList.add('visible');
            } else {
                visionPanel.classList.remove('visible');
            }

            // Update explanation (collapse content when loading a query)
            document.getElementById('explanationTitle').textContent = query.title;
            document.getElementById('explanationContent').innerHTML = query.explanation;
            document.getElementById('explanationContent').classList.add('collapsed');
            document.getElementById('explanationToggle').textContent = 'Show ‚ñº';

            // Update query editor - generate unique order number for Create Order
            let queryText = query.query;
            if (queryId === 'create-order') {
                const orderNum = 'ORD-' + Date.now().toString().slice(-8);
                queryText = queryText.replace('ORD-2024-12345', orderNum);
            }
            document.getElementById('queryEditor').value = queryText;

            // Update active button
            document.querySelectorAll('.query-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.query-btn').classList.add('active');

            // Clear response
            document.getElementById('responseArea').innerHTML = '<pre>Click "Run Query" to see the response...</pre>';
        }

        // Show journey step explanation
        function showStep(step) {
            // Hide webhook tester if visible
            hideWebhookTester();

            const explanations = {
                1: {
                    title: 'Step 1: Calculate Landed Cost',
                    content: `
                        <p>When the customer enters their shipping address, the merchant's website calls Zonos to calculate the total cost.</p>
                        <h4>The API call:</h4>
                        <p><code>landedCostCalculateWorkflow</code></p>
                        <h4>What Zonos returns:</h4>
                        <ul>
                            <li><strong>Duties</strong> - Import taxes (based on product type)</li>
                            <li><strong>Taxes</strong> - VAT/GST for the destination country</li>
                            <li><strong>Fees</strong> - Processing and handling fees</li>
                            <li><strong>Shipping</strong> - Carrier rates if configured</li>
                        </ul>
                        <div class="analogy">
                            <strong>Why this matters:</strong> Customers see the TOTAL cost upfront. No surprise charges at delivery!
                        </div>
                    `
                },
                2: {
                    title: 'Step 2: Customer Pays',
                    content: `
                        <p>The customer sees the full total (product + shipping + duties + taxes) and completes payment.</p>
                        <h4>What they pay:</h4>
                        <ul>
                            <li>Product price</li>
                            <li>Shipping cost</li>
                            <li>Duties & taxes (collected by merchant on behalf of Zonos)</li>
                        </ul>
                        <div class="analogy">
                            <strong>DDP vs DAP:</strong>
                            <br><strong>DDP</strong> (Delivered Duty Paid) - No additional costs. Customer pays everything upfront
                            <br><strong>DAP</strong> (Delivered At Place) - Customer pays customs fees at delivery. Surprise shock experience
                        </div>
                    `
                },
                3: {
                    title: 'Step 3: Create Order',
                    content: `
                        <p>After payment is confirmed, the merchant's system sends the order to Zonos.</p>
                        <h4>The API call:</h4>
                        <p><code>orderCreate</code></p>
                        <h4>What the merchant sends:</h4>
                        <ul>
                            <li>Their order number (from platform, ERP, etc.)</li>
                            <li>The landed cost ID (from step 1)</li>
                            <li>Currency code</li>
                        </ul>
                        <h4>What happens:</h4>
                        <ul>
                            <li>Zonos records the order</li>
                            <li>Zonos fee is charged to merchant</li>
                            <li>Order appears in Zonos Dashboard</li>
                        </ul>
                    `
                },
                4: {
                    title: 'Step 4: Ship & Track',
                    content: `
                        <p>Merchant ships the package and updates Zonos with tracking info.</p>
                        <h4>The API call:</h4>
                        <p><code>shipmentCreateWithTracking</code> or <code>shipmentCreateWorkflow</code></p>
                        <h4>What happens when tracking is added:</h4>
                        <ul>
                            <li>Order status changes to "Fulfilled"</li>
                            <li>Merchant is billed for the duties/taxes they collected</li>
                            <li>Package clears customs smoothly (duties pre-paid!)</li>
                        </ul>
                        <div class="analogy">
                            <strong>This is the magic:</strong> Because Zonos pre-paid the duties, the package doesn't get held at customs waiting for the customer to pay fees. It goes straight through!
                        </div>
                    `
                }
            };

            const exp = explanations[step];
            document.getElementById('explanationTitle').textContent = exp.title;
            document.getElementById('explanationContent').innerHTML = exp.content;
            document.getElementById('explanationContent').classList.add('collapsed');
            document.getElementById('explanationToggle').textContent = 'Show ‚ñº';

            // Update active step
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.toggle('active', i === step - 1);
            });
        }

        // Parse and display friendly view
        function showFriendlyView(query, response) {
            const friendlyView = document.getElementById('friendlyView');
            const inputContent = document.getElementById('friendlyInputContent');
            const outputContent = document.getElementById('friendlyOutputContent');

            // Reset the copy boxes
            document.getElementById('friendlyCopyBox').classList.remove('visible');
            document.getElementById('orderIdCopyBox').classList.remove('visible');
            document.getElementById('shipmentIdCopyBox').classList.remove('visible');

            const isLandedCost = query.includes('landedCostCalculateWorkflow');
            const isClassify = query.includes('classificationsCalculate');
            const isCountryOfOrigin = query.includes('countryOfOriginInfer');
            const isCustomsValue = query.includes('valueEstimate(');
            const isRestrictions = query.includes('itemRestrictionApply');
            const isScreen = query.includes('partyScreen');
            const isVision = query.includes('itemsExtract');
            const friendlyGrid = document.getElementById('friendlyGrid');
            const friendlyStatus = document.getElementById('friendlyStatus');

            if (isClassify) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
                friendlyView.classList.add('visible');

                // Parse what was sent
                const nameMatch = query.match(/name:\s*"([^"]+)"/);
                const descMatch = query.match(/description:\s*"([^"]+)"/);
                const catMatch = query.match(/categories:\s*"([^"]+)"/);
                const countryMatch = query.match(/shipToCountries:\s*(\w+)/);

                let inputHtml = '';
                if (nameMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Product Name</span><span class="friendly-value">${nameMatch[1]}</span></div>`;
                if (descMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Description</span><span class="friendly-value" style="font-size:0.85em; max-width:200px; text-align:right;">${descMatch[1]}</span></div>`;
                if (catMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Category</span><span class="friendly-value">${catMatch[1]}</span></div>`;
                if (countryMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Ship To Country</span><span class="friendly-value">${countryMatch[1]}</span></div>`;
                document.getElementById('friendlyInputContent').innerHTML = inputHtml || '<p style="color:var(--text-muted)">No details parsed.</p>';

                // Parse what came back
                let outputHtml = '';
                if (response.errors && response.errors.length > 0) {
                    outputHtml = `<div style="text-align:center; padding:10px;"><span style="color:#f87171; font-weight:700;">Classification Failed</span><p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">${response.errors[0].message}</p></div>`;
                } else if (response.data && response.data.classificationsCalculate && response.data.classificationsCalculate.length > 0) {
                    const result = response.data.classificationsCalculate[0];
                    const hsCode = result.hsCode?.code || '‚Äî';
                    const hsDesc = result.hsCode?.description?.full || '‚Äî';
                    outputHtml += `<div class="friendly-row"><span class="friendly-label">HS Code</span><span class="friendly-value" style="color:var(--teal); font-size:1.1em; font-family:monospace;">${hsCode}</span></div>`;
                    outputHtml += `<div class="friendly-row" style="flex-direction:column; gap:6px; align-items:flex-start;"><span class="friendly-label">Description</span><span class="friendly-value" style="font-size:0.85em; line-height:1.5; color:var(--text-muted);">${hsDesc}</span></div>`;
                    if (result.id) outputHtml += `<div class="friendly-row"><span class="friendly-label">Classification ID</span><span class="friendly-value" style="font-size:0.78em; font-family:monospace; color:var(--text-muted);">${result.id}</span></div>`;
                } else {
                    outputHtml = '<p style="color:var(--text-muted)">No classification returned.</p>';
                }
                document.getElementById('friendlyOutputContent').innerHTML = outputHtml;
                return;
            }

            if (isCountryOfOrigin) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
                friendlyView.classList.add('visible');

                // Parse what was sent
                const nameMatch = query.match(/name:\s*"([^"]+)"/);
                const brandMatch = query.match(/brand:\s*"([^"]+)"/);
                const materialMatch = query.match(/material:\s*"([^"]+)"/);
                const shipFromMatch = query.match(/shipFromCountry:\s*(\w+)/);
                const amountMatch = query.match(/amount:\s*([\d.]+)/);

                let inputHtml = '';
                if (nameMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Product Name</span><span class="friendly-value">${nameMatch[1]}</span></div>`;
                if (brandMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Brand</span><span class="friendly-value">${brandMatch[1]}</span></div>`;
                if (materialMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Material</span><span class="friendly-value">${materialMatch[1]}</span></div>`;
                if (shipFromMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Ships From</span><span class="friendly-value">${shipFromMatch[1]}</span></div>`;
                if (amountMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Price</span><span class="friendly-value">$${parseFloat(amountMatch[1]).toFixed(2)}</span></div>`;
                document.getElementById('friendlyInputContent').innerHTML = inputHtml || '<p style="color:var(--text-muted)">No details parsed.</p>';

                // Parse what came back
                let outputHtml = '';
                if (response.errors && response.errors.length > 0) {
                    outputHtml = `<div style="text-align:center; padding:10px;"><span style="color:#f87171; font-weight:700;">Prediction Failed</span><p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">${response.errors[0].message}</p></div>`;
                } else if (response.data && response.data.countryOfOriginInfer && response.data.countryOfOriginInfer.length > 0) {
                    const result = response.data.countryOfOriginInfer[0];
                    const country = result.countryOfOrigin || '‚Äî';
                    const score = result.confidenceScore != null ? Math.round(result.confidenceScore * 100) + '%' : '‚Äî';

                    outputHtml += `<div class="friendly-row"><span class="friendly-label">Predicted Origin</span><span class="friendly-value" style="color:var(--teal); font-size:1.2em; font-family:monospace;">${country}</span></div>`;
                    outputHtml += `<div class="friendly-row"><span class="friendly-label">Confidence Score</span><span class="friendly-value" style="color:var(--teal);">${score}</span></div>`;

                    if (result.alternates && result.alternates.length > 0) {
                        const altRows = result.alternates.slice(0, 4).map(a =>
                            `<div class="friendly-row"><span class="friendly-label" style="padding-left:8px;">‚Ü≥ ${a.countryOfOrigin}</span><span class="friendly-value" style="color:var(--text-muted);">${Math.round((a.probabilityMass || 0) * 100)}%</span></div>`
                        ).join('');
                        outputHtml += `<div class="friendly-row"><span class="friendly-label">Alternates</span><span class="friendly-value"></span></div>`;
                        outputHtml += altRows;
                    }
                } else {
                    outputHtml = '<p style="color:var(--text-muted)">No prediction returned.</p>';
                }
                document.getElementById('friendlyOutputContent').innerHTML = outputHtml;
                return;
            }

            if (isCustomsValue) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
                friendlyView.classList.add('visible');

                // Parse what was sent
                const nameMatch = query.match(/name:\s*"([^"]+)"/);
                const brandMatch = query.match(/brand:\s*"([^"]+)"/);
                const currencyMatch = query.match(/currency:\s*(\w+)/);
                const catMatch = query.match(/categories:\s*\[([^\]]+)\]/);

                let inputHtml = '';
                if (nameMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Product Name</span><span class="friendly-value">${nameMatch[1]}</span></div>`;
                if (brandMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Brand</span><span class="friendly-value">${brandMatch[1]}</span></div>`;
                if (currencyMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Currency</span><span class="friendly-value">${currencyMatch[1]}</span></div>`;
                if (catMatch) {
                    const cats = catMatch[1].replace(/["']/g, '').split(',').map(c => c.trim()).join(', ');
                    inputHtml += `<div class="friendly-row"><span class="friendly-label">Categories</span><span class="friendly-value">${cats}</span></div>`;
                }
                document.getElementById('friendlyInputContent').innerHTML = inputHtml || '<p style="color:var(--text-muted)">No details parsed.</p>';

                // Parse what came back
                let outputHtml = '';
                if (response.errors && response.errors.length > 0) {
                    outputHtml = `<div style="text-align:center; padding:10px;"><span style="color:#f87171; font-weight:700;">Estimate Failed</span><p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">${response.errors[0].message}</p></div>`;
                } else if (response.data && response.data.valueEstimate && response.data.valueEstimate.length > 0) {
                    const result = response.data.valueEstimate[0];
                    const currency = result.currency || 'USD';
                    const fmt = (v) => v != null ? `${currency} ${parseFloat(v).toFixed(2)}` : '‚Äî';

                    outputHtml += `<div class="friendly-row"><span class="friendly-label">Estimated Value</span><span class="friendly-value" style="color:var(--teal); font-size:1.15em;">${fmt(result.value)}</span></div>`;
                    if (result.valueEstimateRange) {
                        outputHtml += `<div class="friendly-row"><span class="friendly-label">Low Estimate</span><span class="friendly-value">${fmt(result.valueEstimateRange.low)}</span></div>`;
                        outputHtml += `<div class="friendly-row"><span class="friendly-label">High Estimate</span><span class="friendly-value">${fmt(result.valueEstimateRange.high)}</span></div>`;
                    }
                    if (result.brand) outputHtml += `<div class="friendly-row"><span class="friendly-label">Confirmed Brand</span><span class="friendly-value">${result.brand}</span></div>`;
                } else {
                    outputHtml = '<p style="color:var(--text-muted)">No estimate returned.</p>';
                }
                document.getElementById('friendlyOutputContent').innerHTML = outputHtml;
                return;
            }

            if (isRestrictions) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
                friendlyView.classList.add('visible');

                // Parse what was sent
                const fromMatch = query.match(/shipFromCountry:\s*(\w+)/);
                const toMatch = query.match(/shipToCountry:\s*(\w+)/);
                const carrierMatch = query.match(/carrier:\s*(\w+)/);
                const hsMatch = query.match(/hsCode:\s*"([^"]+)"/);
                const thresholdMatch = query.match(/restrictionTypeThreshold:\s*(\w+)/);

                let inputHtml = '';
                if (fromMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Ship From</span><span class="friendly-value">${fromMatch[1]}</span></div>`;
                if (toMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Ship To</span><span class="friendly-value">${toMatch[1]}</span></div>`;
                if (hsMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">HS Code</span><span class="friendly-value" style="font-family:monospace;">${hsMatch[1]}</span></div>`;
                if (carrierMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Carrier</span><span class="friendly-value">${carrierMatch[1]}</span></div>`;
                if (thresholdMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Check Level</span><span class="friendly-value">${thresholdMatch[1]}</span></div>`;
                document.getElementById('friendlyInputContent').innerHTML = inputHtml;

                // Parse what came back
                let outputHtml = '';
                if (response.errors && response.errors.length > 0) {
                    outputHtml = `<div style="text-align:center; padding:10px;"><span style="color:#f87171; font-weight:700;">Check Failed</span><p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">${response.errors[0].message}</p></div>`;
                } else if (response.data && response.data.itemRestrictionApply) {
                    const result = response.data.itemRestrictionApply;
                    const items = result.items || [];

                    items.forEach(item => {
                        const action = item.action || 'UNKNOWN';
                        const actionColor = action === 'NO_MATCH' ? 'var(--teal)' : action === 'PROHIBITIONS_APPLY' ? '#f87171' : '#fbbf24';
                        const actionLabel = action === 'NO_MATCH' ? '‚úì Clear to Ship' : action === 'PROHIBITIONS_APPLY' ? '‚úó Prohibited' : '‚ö† Restrictions Apply';

                        outputHtml += `<div class="friendly-row"><span class="friendly-label">Result</span><span class="friendly-value" style="color:${actionColor}; font-size:1.05em;">${actionLabel}</span></div>`;
                        if (item.itemHsCode) outputHtml += `<div class="friendly-row"><span class="friendly-label">HS Code Used</span><span class="friendly-value" style="font-family:monospace;">${item.itemHsCode}</span></div>`;

                        const restrictions = item.itemRestrictions || [];
                        if (restrictions.length > 0) {
                            restrictions.forEach((r, i) => {
                                outputHtml += `<div style="margin-top:12px; padding:12px; background:rgba(248,113,113,0.08); border:1px solid rgba(248,113,113,0.2); border-radius:8px; font-size:0.85em;">`;
                                outputHtml += `<div style="font-weight:700; color:#f87171; margin-bottom:6px;">${r.type || ''} ‚Äî ${r.controlType || ''}</div>`;
                                if (r.controlSummary) outputHtml += `<div style="color:var(--text-muted); margin-bottom:4px;">${r.controlSummary}</div>`;
                                if (r.note) outputHtml += `<div style="color:var(--text-dim); font-style:italic;">${r.note}</div>`;
                                if (r.sources && r.sources.length > 0) outputHtml += `<div style="color:var(--text-dim); margin-top:4px;">Source: ${r.sources.join(', ')}</div>`;
                                outputHtml += `</div>`;
                            });
                        } else if (action === 'NO_MATCH') {
                            outputHtml += `<div style="margin-top:10px; color:var(--text-muted); font-size:0.9em;">No restrictions found for this item on this route.</div>`;
                        }
                    });
                } else {
                    outputHtml = '<p style="color:var(--text-muted)">No results returned.</p>';
                }
                document.getElementById('friendlyOutputContent').innerHTML = outputHtml;
                return;
            }

            if (isScreen) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
                friendlyView.classList.add('visible');

                // Parse what was sent
                const firstNameMatch = query.match(/firstName:\s*"([^"]+)"/);
                const lastNameMatch = query.match(/lastName:\s*"([^"]+)"/);
                const countryMatch = query.match(/countryCode:\s*"?([A-Z]{2})"?/);
                const localityMatch = query.match(/locality:\s*"([^"]+)"/);
                const line1Match = query.match(/line1:\s*"([^"]+)"/);
                const areaMatch = query.match(/administrativeAreaCode:\s*"([^"]+)"/);

                let inputHtml = '';
                if (firstNameMatch || lastNameMatch) {
                    const fullName = [firstNameMatch && firstNameMatch[1], lastNameMatch && lastNameMatch[1]].filter(Boolean).join(' ');
                    inputHtml += `<div class="friendly-row"><span class="friendly-label">Name</span><span class="friendly-value">${fullName}</span></div>`;
                }
                if (countryMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">Country</span><span class="friendly-value">${countryMatch[1]}</span></div>`;
                if (localityMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">City</span><span class="friendly-value">${localityMatch[1]}</span></div>`;
                if (areaMatch) inputHtml += `<div class="friendly-row"><span class="friendly-label">State</span><span class="friendly-value">${areaMatch[1]}</span></div>`;
                if (line1Match) inputHtml += `<div class="friendly-row"><span class="friendly-label">Address</span><span class="friendly-value">${line1Match[1]}</span></div>`;
                document.getElementById('friendlyInputContent').innerHTML = inputHtml || '<p style="color:var(--text-muted)">No details parsed.</p>';

                // Parse what came back
                let outputHtml = '';
                if (response.errors && response.errors.length > 0) {
                    outputHtml = `<div style="text-align:center; padding:10px;"><span style="color:#f87171; font-weight:700; font-size:1.2em;">Screening Failed</span><p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">${response.errors[0].message}</p></div>`;
                } else if (response.data && response.data.partyScreen) {
                    const result = response.data.partyScreen;
                    const action = result.action;
                    const matches = result.matches || [];

                    if (action === 'NO_MATCHES') {
                        outputHtml += `<div style="text-align:center; padding:10px 0 14px;">
                            <span style="font-size:1.4em; color:var(--teal); font-weight:700;">NO_MATCHES</span>
                            <p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">No denied party matches found. Safe to ship.</p>
                        </div>`;
                    } else if (action === 'REVIEW') {
                        outputHtml += `<div style="text-align:center; padding:10px 0 14px;">
                            <span style="font-size:1.4em; color:#f59e0b; font-weight:700;">REVIEW</span>
                            <p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">Potential denied party match found. Do not ship until verified.</p>
                        </div>`;
                    } else if (action) {
                        outputHtml += `<div style="text-align:center; padding:10px 0 14px;">
                            <span style="font-size:1.4em; color:var(--text); font-weight:700;">${action}</span>
                        </div>`;
                    }

                    if (matches.length > 0) {
                        outputHtml += `<div style="font-size:0.85em; color:var(--text-muted); margin-bottom:8px; font-weight:600;">${matches.length} match${matches.length > 1 ? 'es' : ''} found:</div>`;
                        matches.forEach((m, i) => {
                            const overall = m.scores && m.scores.overall !== undefined ? (m.scores.overall * 100).toFixed(0) + '%' : '‚Äî';
                            const nameScore = m.scores && m.scores.name !== undefined ? (m.scores.name * 100).toFixed(0) + '%' : '‚Äî';
                            const locScore = m.scores && m.scores.location !== undefined ? (m.scores.location * 100).toFixed(0) + '%' : '‚Äî';
                            const matchName = m.companyName || m.name || '‚Äî';
                            const location = [m.locality, m.countryCode].filter(Boolean).join(', ') || '‚Äî';
                            outputHtml += `<div style="border:1px solid rgba(245,158,11,0.3); border-radius:10px; padding:12px; margin-bottom:10px; background:rgba(245,158,11,0.05);">
                                <div style="font-weight:600; color:#f59e0b; margin-bottom:6px;">${matchName}</div>
                                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; font-size:0.85em;">
                                    <div style="text-align:center; background:rgba(255,255,255,0.04); border-radius:6px; padding:6px;">
                                        <div style="color:var(--text-muted); font-size:0.8em;">Overall</div>
                                        <div style="color:var(--text); font-weight:600;">${overall}</div>
                                    </div>
                                    <div style="text-align:center; background:rgba(255,255,255,0.04); border-radius:6px; padding:6px;">
                                        <div style="color:var(--text-muted); font-size:0.8em;">Name Score</div>
                                        <div style="color:var(--text); font-weight:600;">${nameScore}</div>
                                    </div>
                                    <div style="text-align:center; background:rgba(255,255,255,0.04); border-radius:6px; padding:6px;">
                                        <div style="color:var(--text-muted); font-size:0.8em;">Location Score</div>
                                        <div style="color:var(--text); font-weight:600;">${locScore}</div>
                                    </div>
                                </div>
                                ${location !== '‚Äî' ? `<div style="margin-top:8px; font-size:0.8em; color:var(--text-dim);">Location: ${location}</div>` : ''}
                            </div>`;
                        });
                    }
                } else {
                    outputHtml = '<p style="color:var(--text-muted)">No results returned.</p>';
                }
                document.getElementById('friendlyOutputContent').innerHTML = outputHtml;
                return;
            }

            if (isVision) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
                friendlyView.classList.add('visible');

                // What was sent: the uploaded image thumbnail
                const previewSrc = document.getElementById('visionPreviewImg').src;
                let inputHtml = '';
                if (previewSrc) {
                    inputHtml += `<div style="text-align:center; margin-bottom:8px;"><img src="${previewSrc}" style="max-width:100%; max-height:140px; border-radius:10px; border:1px solid var(--border);"></div>`;
                }
                inputHtml += `<div class="friendly-row"><span class="friendly-label">Ship To</span><span class="friendly-value">US</span></div>`;
                inputHtml += `<div class="friendly-row"><span class="friendly-label">Classify</span><span class="friendly-value">Enabled</span></div>`;
                inputHtml += `<div class="friendly-row"><span class="friendly-label">Estimate Value</span><span class="friendly-value">Enabled</span></div>`;
                document.getElementById('friendlyInputContent').innerHTML = inputHtml;

                // What came back: one card per detected item
                let outputHtml = '';
                if (response.errors && response.errors.length > 0) {
                    outputHtml = `<div style="text-align:center; padding:10px;"><span style="color:#f87171; font-weight:700;">Analysis Failed</span><p style="color:var(--text-muted); margin-top:8px; font-size:0.9em;">${response.errors[0].message}</p></div>`;
                } else if (response.data && response.data.itemsExtract && response.data.itemsExtract.length > 0) {
                    const items = response.data.itemsExtract;
                    outputHtml += `<div style="font-size:0.85em; color:var(--text-muted); margin-bottom:10px; font-weight:600;">${items.length} item${items.length > 1 ? 's' : ''} detected</div>`;
                    items.forEach((item, i) => {
                        const content = Array.isArray(item.content) ? item.content[0] : item.content;
                        const name = content && content.name ? content.name : 'Unknown item';
                        const desc = content && content.description ? content.description : '';
                        const materials = content && content.materials ? content.materials : '';
                        const hsCode = item.classification && item.classification.hsCode ? item.classification.hsCode.code : null;
                        const confidence = item.classification && item.classification.confidenceScore !== undefined ? (item.classification.confidenceScore * 100).toFixed(0) + '%' : null;
                        const value = item.valueEstimation && item.valueEstimation.value !== undefined ? item.valueEstimation.value : null;
                        const currency = item.valueEstimation ? (item.valueEstimation.currency || 'USD') : 'USD';
                        const low = item.valueEstimation && item.valueEstimation.valueEstimateRange ? item.valueEstimation.valueEstimateRange.low : null;
                        const high = item.valueEstimation && item.valueEstimation.valueEstimateRange ? item.valueEstimation.valueEstimateRange.high : null;

                        outputHtml += `<div style="border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:12px; background:rgba(0,185,183,0.04);">
                            <div style="font-weight:600; color:var(--teal); margin-bottom:6px; font-size:1em;">${name}</div>
                            ${desc ? `<div style="color:var(--text-muted); font-size:0.85em; margin-bottom:10px;">${desc}</div>` : ''}
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.85em;">
                                ${hsCode ? `<div style="background:rgba(255,255,255,0.04); border-radius:8px; padding:8px;">
                                    <div style="color:var(--text-muted); font-size:0.8em; margin-bottom:2px;">HS Code</div>
                                    <div style="color:var(--text); font-weight:600; font-family:monospace;">${hsCode}</div>
                                    ${confidence ? `<div style="color:var(--teal); font-size:0.8em;">${confidence} confidence</div>` : ''}
                                </div>` : ''}
                                ${value !== null ? `<div style="background:rgba(255,255,255,0.04); border-radius:8px; padding:8px;">
                                    <div style="color:var(--text-muted); font-size:0.8em; margin-bottom:2px;">Est. Value</div>
                                    <div style="color:var(--text); font-weight:600;">${currency} ${value.toFixed(2)}</div>
                                    ${low !== null && high !== null ? `<div style="color:var(--text-muted); font-size:0.8em;">Range: ${low.toFixed(2)}‚Äì${high.toFixed(2)}</div>` : ''}
                                </div>` : ''}
                            </div>
                            ${materials ? `<div style="margin-top:8px; font-size:0.8em; color:var(--text-dim);">Materials: ${materials}</div>` : ''}
                        </div>`;
                    });
                } else {
                    outputHtml = '<p style="color:var(--text-muted)">No items detected in image.</p>';
                }
                document.getElementById('friendlyOutputContent').innerHTML = outputHtml;
                return;
            }

            if (isLandedCost) {
                friendlyGrid.style.display = '';
                friendlyStatus.style.display = 'none';
            } else {
                friendlyGrid.style.display = 'none';
                friendlyStatus.style.display = '';

                // Simple success/failed for non-landed-cost queries
                let statusHtml = '';
                if (response.errors && response.errors.length > 0) {
                    statusHtml = '<div style="text-align: center; padding: 20px;"><span style="font-size: 1.5em; color: #dc2626; font-weight: 700;">Failed</span><p style="color: #6b7280; margin-top: 10px;">' + response.errors[0].message + '</p></div>';
                } else {
                    statusHtml = '<div style="text-align: center; padding: 20px;"><span style="font-size: 1.5em; color: #059669; font-weight: 700;">Success</span></div>';
                }
                document.getElementById('friendlyStatusContent').innerHTML = statusHtml;

                // Still show copy boxes for relevant mutations
                if (response.data) {
                    const data = response.data;
                    if (data.orderCreate && data.orderCreate.id) {
                        const copyBox = document.getElementById('orderIdCopyBox');
                        document.getElementById('orderIdValue').textContent = data.orderCreate.id;
                        copyBox.classList.add('visible');
                    }
                    if (data.shipmentCreateWorkflow && data.shipmentCreateWorkflow.id) {
                        const copyBox = document.getElementById('shipmentIdCopyBox');
                        document.getElementById('shipmentIdValue').textContent = data.shipmentCreateWorkflow.id;
                        copyBox.classList.add('visible');
                    }
                }

                friendlyView.classList.add('visible');
                return;
            }

            let inputHtml = '';
            let itemName = null;
            let itemPrice = null;
            let itemQty = null;
            let shipFrom = null;
            let shipTo = null;
            let currency = 'USD';

            // Parse item info from mutation/query
            const nameMatch = query.match(/name:\s*"([^"]+)"/);
            const amountMatch = query.match(/amount:\s*([\d.]+)/);
            const qtyMatch = query.match(/quantity:\s*(\d+)/);
            const currencyMatch = query.match(/currencyCode:\s*(\w+)/);

            // Parse shipping from parties in mutation
            // Match ORIGIN block and extract location details
            const originBlock = query.match(/type:\s*ORIGIN[\s\S]*?locality:\s*"([^"]+)"[\s\S]*?administrativeAreaCode:\s*"([^"]+)"[\s\S]*?countryCode:\s*(\w+)|type:\s*ORIGIN[\s\S]*?countryCode:\s*(\w+)/);
            const destBlock = query.match(/type:\s*DESTINATION[\s\S]*?locality:\s*"([^"]+)"[\s\S]*?administrativeAreaCode:\s*"([^"]+)"[\s\S]*?countryCode:\s*(\w+)|type:\s*DESTINATION[\s\S]*?countryCode:\s*(\w+)/);

            // Simpler parsing for parties
            const originCountry = query.match(/ORIGIN[\s\S]*?countryCode:\s*(\w+)/);
            const originLocality = query.match(/ORIGIN[\s\S]*?locality:\s*"([^"]+)"/);
            const originAdmin = query.match(/ORIGIN[\s\S]*?administrativeAreaCode:\s*"([^"]+)"/);

            const destCountry = query.match(/DESTINATION[\s\S]*?countryCode:\s*(\w+)/);
            const destLocality = query.match(/DESTINATION[\s\S]*?locality:\s*"([^"]+)"/);
            const destAdmin = query.match(/DESTINATION[\s\S]*?administrativeAreaCode:\s*"([^"]+)"/);

            // Extract item details
            if (nameMatch) itemName = nameMatch[1];
            if (amountMatch) itemPrice = '$' + parseFloat(amountMatch[1]).toFixed(2);
            if (qtyMatch) itemQty = qtyMatch[1];
            if (currencyMatch) currency = currencyMatch[1];

            // Build ship from location
            if (originCountry) {
                const parts = [];
                if (originLocality) parts.push(originLocality[1]);
                if (originAdmin) parts.push(originAdmin[1]);
                parts.push(originCountry[1]);
                shipFrom = parts.join(', ');
            }

            // Build ship to location
            if (destCountry) {
                const parts = [];
                if (destLocality) parts.push(destLocality[1]);
                if (destAdmin) parts.push(destAdmin[1]);
                parts.push(destCountry[1]);
                shipTo = parts.join(', ');
            }

            // For order lookups, get info from response
            if (response.data && response.data.order) {
                const order = response.data.order;

                // Get item info
                if (order.items && order.items.length > 0) {
                    const item = order.items[0];
                    if (item.description) itemName = item.description;
                    if (item.amount != null) itemPrice = '$' + parseFloat(item.amount).toFixed(2);
                    if (item.quantity != null) itemQty = item.quantity.toString();

                    // Show all items if more than one
                    if (order.items.length > 1) {
                        itemName = item.description + ' (+' + (order.items.length - 1) + ' more)';
                    }
                }

                // Get shipping info from parties
                if (order.parties && order.parties.length > 0) {
                    const origin = order.parties.find(p => p.type === 'ORIGIN');
                    const dest = order.parties.find(p => p.type === 'DESTINATION');

                    if (origin && origin.location) {
                        const loc = origin.location;
                        const parts = [];
                        if (loc.locality) parts.push(loc.locality);
                        if (loc.administrativeAreaCode) parts.push(loc.administrativeAreaCode);
                        if (loc.countryCode) parts.push(loc.countryCode);
                        shipFrom = parts.length > 0 ? parts.join(', ') : loc.countryCode;
                    }
                    if (dest && dest.location) {
                        const loc = dest.location;
                        const parts = [];
                        if (loc.locality) parts.push(loc.locality);
                        if (loc.administrativeAreaCode) parts.push(loc.administrativeAreaCode);
                        if (loc.countryCode) parts.push(loc.countryCode);
                        shipTo = parts.length > 0 ? parts.join(', ') : loc.countryCode;
                    }
                }
            }

            // Build input section - only show rows with data
            if (itemName) {
                inputHtml += '<div class="friendly-row"><span class="friendly-label">Item</span><span class="friendly-value">' + itemName + '</span></div>';
            }
            if (itemPrice) {
                inputHtml += '<div class="friendly-row"><span class="friendly-label">Price</span><span class="friendly-value money">' + itemPrice + ' ' + currency + '</span></div>';
            }
            if (itemQty) {
                inputHtml += '<div class="friendly-row"><span class="friendly-label">Quantity</span><span class="friendly-value">' + itemQty + '</span></div>';
            }
            if (shipFrom) {
                inputHtml += '<div class="friendly-row"><span class="friendly-label">Ship From</span><span class="friendly-value">' + shipFrom + '</span></div>';
            }
            if (shipTo) {
                inputHtml += '<div class="friendly-row"><span class="friendly-label">Ship To</span><span class="friendly-value">' + shipTo + '</span></div>';
            }

            // Fallback if no data found
            if (!inputHtml) {
                inputHtml = '<div class="friendly-row"><span class="friendly-label">Query</span><span class="friendly-value">See raw response for details</span></div>';
            }

            inputContent.innerHTML = inputHtml;

            // Parse the response
            let outputHtml = '';

            if (response.errors && response.errors.length > 0) {
                outputHtml = '<div class="friendly-row"><span class="friendly-label">Error</span><span class="friendly-value" style="color: #dc2626;">' + response.errors[0].message.substring(0, 50) + '...</span></div>';
            } else if (response.data) {
                const data = response.data;

                // Handle landed cost response (from query or workflow mutation)
                let lc = data.landedCost || data.landedCostCalculateWorkflow;
                // Handle if response is an array
                if (Array.isArray(lc) && lc.length > 0) {
                    lc = lc[0];
                }
                if (lc) {
                    let totalDuties = 0;
                    let totalTaxes = 0;
                    let totalFees = 0;
                    let shippingCost = 0;
                    let curr = 'USD';

                    // Get shipping cost from shipmentRating workflow if available
                    const shippingData = data.shipmentRatingCalculateWorkflow || data.shipmentRatingCreateWorkflow;
                    if (shippingData) {
                        if (Array.isArray(shippingData) && shippingData.length > 0) {
                            shippingCost = parseFloat(shippingData[0].amount) || 0;
                        } else if (shippingData.amount) {
                            shippingCost = parseFloat(shippingData.amount) || 0;
                        }
                    }

                    // Calculate totals from landed cost
                    if (lc.duties && lc.duties.length > 0) {
                        lc.duties.forEach(d => {
                            totalDuties += parseFloat(d.amount) || 0;
                            curr = d.currency || curr;
                        });
                    }
                    if (lc.taxes && lc.taxes.length > 0) {
                        lc.taxes.forEach(t => {
                            totalTaxes += parseFloat(t.amount) || 0;
                            curr = t.currency || curr;
                        });
                    }
                    if (lc.fees && lc.fees.length > 0) {
                        lc.fees.forEach(f => {
                            totalFees += parseFloat(f.amount) || 0;
                            curr = f.currency || curr;
                        });
                    }

                    // Show shipping cost
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Shipping</span><span class="friendly-value money">$' + shippingCost.toFixed(2) + ' ' + curr + '</span></div>';

                    // Always show duties, taxes, fees
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Duties</span><span class="friendly-value money">$' + totalDuties.toFixed(2) + ' ' + curr + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Taxes</span><span class="friendly-value money">$' + totalTaxes.toFixed(2) + ' ' + curr + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Fees</span><span class="friendly-value money">$' + totalFees.toFixed(2) + ' ' + curr + '</span></div>';

                    const total = shippingCost + totalDuties + totalTaxes + totalFees;
                    outputHtml += '<div class="friendly-total"><span class="friendly-label">Total Landed Cost</span><span class="friendly-value money">$' + total.toFixed(2) + ' ' + curr + '</span></div>';

                    // Show the Landed Cost ID copy box
                    if (lc.id) {
                        const copyBox = document.getElementById('friendlyCopyBox');
                        document.getElementById('landedCostIdValue').textContent = lc.id;
                        copyBox.classList.add('visible');
                    }
                }

                // Handle order response
                if (data.order) {
                    const order = data.order;
                    let totalDuties = 0, totalTaxes = 0, totalFees = 0;
                    let curr = 'USD';

                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Order #</span><span class="friendly-value">' + (order.accountOrderNumber || order.id) + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Status</span><span class="friendly-value">' + (order.status || 'N/A') + '</span></div>';

                    // Show tracking if available
                    if (order.shipments && order.shipments.length > 0) {
                        const shipment = order.shipments[0];
                        if (shipment.trackingNumbers && shipment.trackingNumbers.length > 0) {
                            outputHtml += '<div class="friendly-row"><span class="friendly-label">Tracking</span><span class="friendly-value">' + shipment.trackingNumbers[0] + '</span></div>';
                        }
                    }

                    if (order.landedCosts && order.landedCosts.length > 0) {
                        const lc = order.landedCosts[0];

                        if (lc.duties) lc.duties.forEach(d => {
                            totalDuties += parseFloat(d.amount) || 0;
                            curr = d.currency || curr;
                        });
                        if (lc.taxes) lc.taxes.forEach(t => {
                            totalTaxes += parseFloat(t.amount) || 0;
                            curr = t.currency || curr;
                        });
                        if (lc.fees) lc.fees.forEach(f => {
                            totalFees += parseFloat(f.amount) || 0;
                            curr = f.currency || curr;
                        });

                        // Always show duties, taxes, fees
                        outputHtml += '<div class="friendly-row"><span class="friendly-label">Duties</span><span class="friendly-value money">$' + totalDuties.toFixed(2) + ' ' + curr + '</span></div>';
                        outputHtml += '<div class="friendly-row"><span class="friendly-label">Taxes</span><span class="friendly-value money">$' + totalTaxes.toFixed(2) + ' ' + curr + '</span></div>';
                        outputHtml += '<div class="friendly-row"><span class="friendly-label">Fees</span><span class="friendly-value money">$' + totalFees.toFixed(2) + ' ' + curr + '</span></div>';

                        const total = totalDuties + totalTaxes + totalFees;
                        if (total > 0) {
                            outputHtml += '<div class="friendly-total"><span class="friendly-label">Total Import Costs</span><span class="friendly-value money">$' + total.toFixed(2) + ' ' + curr + '</span></div>';
                        }
                    }
                }

                // Handle orderCreate response
                if (data.orderCreate) {
                    const order = data.orderCreate;
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Order ID</span><span class="friendly-value">' + order.id + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Order #</span><span class="friendly-value">' + (order.accountOrderNumber || 'N/A') + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Status</span><span class="friendly-value">' + (order.status || 'N/A') + '</span></div>';

                    if (order.amountSubtotals) {
                        const s = order.amountSubtotals;
                        if (s.duties) outputHtml += '<div class="friendly-row"><span class="friendly-label">Duties</span><span class="friendly-value money">$' + parseFloat(s.duties).toFixed(2) + '</span></div>';
                        if (s.taxes) outputHtml += '<div class="friendly-row"><span class="friendly-label">Taxes</span><span class="friendly-value money">$' + parseFloat(s.taxes).toFixed(2) + '</span></div>';
                        if (s.fees) outputHtml += '<div class="friendly-row"><span class="friendly-label">Fees</span><span class="friendly-value money">$' + parseFloat(s.fees).toFixed(2) + '</span></div>';
                        if (s.shipping) outputHtml += '<div class="friendly-row"><span class="friendly-label">Shipping</span><span class="friendly-value money">$' + parseFloat(s.shipping).toFixed(2) + '</span></div>';
                        if (s.items) outputHtml += '<div class="friendly-row"><span class="friendly-label">Items</span><span class="friendly-value money">$' + parseFloat(s.items).toFixed(2) + '</span></div>';
                    }

                    // Show the Order ID copy box
                    if (order.id) {
                        const copyBox = document.getElementById('orderIdCopyBox');
                        document.getElementById('orderIdValue').textContent = order.id;
                        copyBox.classList.add('visible');
                    }
                }

                // Handle shipmentCreateWorkflow response
                if (data.shipmentCreateWorkflow) {
                    const shipment = data.shipmentCreateWorkflow;
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Shipment ID</span><span class="friendly-value">' + shipment.id + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Status</span><span class="friendly-value">' + (shipment.status || 'N/A') + '</span></div>';

                    if (shipment.trackingDetails && shipment.trackingDetails.number) {
                        outputHtml += '<div class="friendly-row"><span class="friendly-label">Tracking #</span><span class="friendly-value">' + shipment.trackingDetails.number + '</span></div>';
                    }
                    if (shipment.serviceLevel) {
                        if (shipment.serviceLevel.name) {
                            outputHtml += '<div class="friendly-row"><span class="friendly-label">Service</span><span class="friendly-value">' + shipment.serviceLevel.name + '</span></div>';
                        }
                        if (shipment.serviceLevel.carrier && shipment.serviceLevel.carrier.name) {
                            outputHtml += '<div class="friendly-row"><span class="friendly-label">Carrier</span><span class="friendly-value">' + shipment.serviceLevel.carrier.name + '</span></div>';
                        }
                    }

                    // Show the Shipment ID copy box
                    if (shipment.id) {
                        const copyBox = document.getElementById('shipmentIdCopyBox');
                        document.getElementById('shipmentIdValue').textContent = shipment.id;
                        copyBox.classList.add('visible');
                    }
                }

                // Handle shipmentStatusUpdate response (void shipment)
                if (data.shipmentStatusUpdate) {
                    const shipment = data.shipmentStatusUpdate;
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Shipment ID</span><span class="friendly-value">' + shipment.id + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Status</span><span class="friendly-value">' + (shipment.status || 'N/A') + '</span></div>';
                }

                // Handle orders list
                if (data.orders && data.orders.edges) {
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Orders Found</span><span class="friendly-value">' + data.orders.edges.length + '</span></div>';
                    data.orders.edges.slice(0, 3).forEach((edge, i) => {
                        const o = edge.node;
                        outputHtml += '<div class="friendly-row"><span class="friendly-label">' + (o.accountOrderNumber || 'Order ' + (i+1)) + '</span><span class="friendly-value">' + o.status + '</span></div>';
                    });
                }

                // Handle organization check
                if (data.organization) {
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Organization</span><span class="friendly-value">' + (data.organization.name || data.organization.id) + '</span></div>';
                    outputHtml += '<div class="friendly-row"><span class="friendly-label">Connection</span><span class="friendly-value" style="color: #059669;">Success</span></div>';
                }

                if (!outputHtml) {
                    outputHtml = '<div class="friendly-row"><span class="friendly-label">Status</span><span class="friendly-value" style="color: #059669;">Success</span></div>';
                }
            }

            outputContent.innerHTML = outputHtml || '<div class="friendly-row"><span class="friendly-label">No data</span><span class="friendly-value">-</span></div>';
            friendlyView.classList.add('visible');
        }

        // Copy any ID from a copy box to clipboard
        function copyCopyBox(elementId, btn) {
            const id = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(id).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy ID';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Run the query
        async function runQuery() {
            const apiKey = document.getElementById('apiKey').value;
            const endpoint = document.getElementById('endpoint').value;
            const query = document.getElementById('queryEditor').value;
            const responseArea = document.getElementById('responseArea');
            const runBtn = document.getElementById('runBtn');

            // Check for placeholder IDs that haven't been replaced
            if (query.includes('PASTE_YOUR_LANDED_COST_ID_HERE')) {
                responseArea.innerHTML = '<pre class="response-error">You need to paste a Landed Cost ID first!\n\n1. Run "Calculate Landed Cost" first\n2. Copy the Landed Cost ID from the Results Summary\n3. Come back here and replace PASTE_YOUR_LANDED_COST_ID_HERE with the ID you copied\n4. Then click Run Query</pre>';
                return;
            }
            if (query.includes('PASTE_YOUR_ORDER_ID_HERE')) {
                const isCancel = query.includes('orderCancel');
                const msg = isCancel
                    ? 'You need to paste an Order ID first!\n\n1. Use the Order ID from the order you already created\n2. Replace PASTE_YOUR_ORDER_ID_HERE with that Order ID\n3. Then click Run Query'
                    : 'You need to paste an Order ID first!\n\n1. Run "Create an Order" first\n2. Copy the Order ID from the Results Summary\n3. Come back here and replace PASTE_YOUR_ORDER_ID_HERE with the ID you copied\n4. Then click Run Query';
                responseArea.innerHTML = '<pre class="response-error">' + msg + '</pre>';
                return;
            }
            if (query.includes('PASTE_YOUR_SHIPMENT_ID_HERE')) {
                responseArea.innerHTML = '<pre class="response-error">You need to paste a Shipment ID first!\n\n1. Run "Add Tracking Number" first\n2. Copy the Shipment ID from the Results Summary\n3. Come back here and replace PASTE_YOUR_SHIPMENT_ID_HERE with the ID you copied\n4. Then click Run Query</pre>';
                return;
            }
            if (query.includes('itemsExtract') && !visionImageBase64) {
                responseArea.innerHTML = '<pre class="response-error">Please upload an image first!\n\nUse the upload panel above to select a JPEG, PNG, or HEIC photo, then click Run Query.</pre>';
                return;
            }

            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="loading"></span> Running...';
            responseArea.innerHTML = '<pre>Sending request to Zonos...</pre>';

            try {
                const response = await fetch('/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: endpoint,
                        method: 'POST',
                        headers: Object.assign(
                            { 'Content-Type': 'application/json' },
                            apiKey ? { 'credentialToken': apiKey } : {}
                        ),
                        body: query.includes('itemsExtract') ? {
                            query: query,
                            variables: {
                                input: {
                                    imageBase64: visionImageBase64,
                                    localizedLanguageCode: 'EN',
                                    shipToCountry: 'US',
                                    configuration: {
                                        classify: 'ENABLED',
                                        estimateValue: 'ENABLED'
                                    }
                                }
                            }
                        } : {
                            query: query
                        }
                    })
                });

                const result = await response.json();

                if (result.error) {
                    responseArea.innerHTML = `<pre class="response-error">${result.message}</pre>`;
                    document.getElementById('friendlyView').classList.remove('visible');
                    document.getElementById('friendlyCopyBox').classList.remove('visible');
                    document.getElementById('orderIdCopyBox').classList.remove('visible');
            document.getElementById('shipmentIdCopyBox').classList.remove('visible');
                } else {
                    const body = JSON.parse(result.body);
                    responseArea.innerHTML = `<pre class="response-success">${JSON.stringify(body, null, 2)}</pre>`;
                    showFriendlyView(query, body);
                    fireWebhookFromResponse(body);
                }
            } catch (error) {
                responseArea.innerHTML = `<pre class="response-error">Error: ${error.message}\n\nMake sure the server is running:\ncd ~/my-app && python3 server.py</pre>`;
            }

            runBtn.disabled = false;
            runBtn.textContent = 'Run Query';
        }

        // ============ WEBHOOK TESTER ============

        let SUPABASE_URL = '';
        let SUPABASE_ANON_KEY = '';

        // Fetch Supabase config from server (keeps keys out of client source)
        fetch('/config').then(r => r.json()).then(cfg => {
            SUPABASE_URL = cfg.supabaseUrl || '';
            SUPABASE_ANON_KEY = cfg.supabaseAnonKey || '';
        }).catch(() => {});

        let webhookSessionId = localStorage.getItem('webhook_session_id');
        if (!webhookSessionId) {
            webhookSessionId = crypto.randomUUID();
            localStorage.setItem('webhook_session_id', webhookSessionId);
        }

        let webhookPollingInterval = null;
        let webhookEvents = [];
        let lastEventTime = null;
        let webhookClearedAt = null;

        function getWebhookUrl() {
            const base = window.location.origin;
            return `${base}/webhook/${webhookSessionId}`;
        }

        function showWebhookView() {
            // Hide other panels
            document.getElementById('friendlyView').classList.remove('visible');

            // Show webhook explanation
            const explanation = document.querySelector('.explanation');
            explanation.style.display = '';
            document.getElementById('explanationTitle').textContent = 'Webhooks';
            document.getElementById('explanationContent').innerHTML = `
                    <h4>What are webhooks?</h4>
                    <p>Webhooks are <strong>automatic notifications FROM Zonos TO the merchant's server</strong>. The merchant doesn't ask for them &mdash; Zonos sends them whenever something happens.</p>

                    <h4>The real flow:</h4>
                    <div style="background: linear-gradient(135deg, rgba(0,185,183,0.12) 0%, rgba(49,34,246,0.12) 100%); border-radius: 12px; padding: 18px; margin: 12px 0;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center; font-weight: 600; color: var(--teal);">
                            <span style="background: rgba(255,255,255,0.07); padding: 8px 14px; border-radius: 8px; border: 1px solid rgba(0,185,183,0.3); color: var(--text);">1. Something happens in Zonos</span>
                            <span style="font-size: 1.3em;">&rarr;</span>
                            <span style="background: rgba(255,255,255,0.07); padding: 8px 14px; border-radius: 8px; border: 1px solid rgba(0,185,183,0.3); color: var(--text);">2. Zonos POSTs to merchant's URL</span>
                            <span style="font-size: 1.3em;">&rarr;</span>
                            <span style="background: rgba(255,255,255,0.07); padding: 8px 14px; border-radius: 8px; border: 1px solid rgba(0,185,183,0.3); color: var(--text);">3. Merchant receives the data</span>
                        </div>
                    </div>
                    <p>For example: a merchant creates an order via the API &rarr; Zonos automatically sends an <code>ORDER_CREATED</code> webhook to the merchant's server with the order details.</p>

                    <div class="analogy">
                        <strong>Real-world analogy:</strong>
                        <br>API = You calling the pizza shop to place an order
                        <br>Webhook = The pizza shop calling YOU to say "your pizza is ready!"
                        <br><br>You don't ask "is it ready yet?" over and over. They just call you when it's done.
                    </div>

                    <h4>How merchants set this up:</h4>
                    <p>The merchant gives Zonos a URL using the <code>webhookCreate</code> API mutation and picks which events they want to hear about. After that, it's automatic.</p>

                    <details style="margin-top: 14px; border: 1px solid rgba(0,185,183,0.3); border-radius: 10px; overflow: hidden;">
                        <summary style="cursor: pointer; padding: 12px 16px; background: linear-gradient(135deg, rgba(0,185,183,0.12) 0%, rgba(49,34,246,0.12) 100%); font-weight: 600; color: var(--teal); font-size: 0.9em; list-style: none; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">&#9654;</span> See the <code style="background: rgba(0,185,183,0.15); padding: 2px 6px; border-radius: 4px;">webhookCreate</code> mutation
                        </summary>
                        <div style="padding: 16px; background: #1e1e2e;">
                            <p style="color: #a6adc8; font-size: 0.8em; margin: 0 0 12px 0;">Run this once per event type you want to receive. There are 5 event types, so 5 mutations total.</p>
                            <pre style="margin: 0; color: #cdd6f4; font-size: 0.85em; line-height: 1.6; overflow-x: auto; white-space: pre;"><span style="color: #89b4fa;">mutation</span> <span style="color: #a6e3a1;">WebhookCreate</span> {
  <span style="color: #89dceb;">webhookCreate</span>(input: {
    url: <span style="color: #a6e3a1;">"https://your-server.com/webhooks/zonos"</span>
    type: <span style="color: #fab387;">ORDER_CREATED</span>  <span style="color: #6c7086;"># run again for each event type:</span>
    status: <span style="color: #fab387;">ENABLED</span>     <span style="color: #6c7086;"># ORDER_CANCELED, ORDER_STATUS_CHANGED,</span>
                         <span style="color: #6c7086;"># SHIPMENT_CREATED, SHIPMENT_CANCELED</span>
  }) {
    <span style="color: #cdd6f4;">id</span>
    <span style="color: #cdd6f4;">url</span>
    <span style="color: #cdd6f4;">type</span>
    <span style="color: #cdd6f4;">status</span>
  }
}</pre>
                        </div>
                    </details>
            `;
            // Show webhook content expanded by default
            document.getElementById('explanationContent').classList.remove('collapsed');
            document.getElementById('explanationToggle').textContent = 'Hide ‚ñ≤';

            // Show webhook tester, hide editor
            document.getElementById('webhookTester').classList.add('visible');
            document.querySelector('.editor-area').style.display = 'none';

            // Update active button
            document.querySelectorAll('.query-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('webhookTesterBtn').classList.add('active');

            // Deactivate journey steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));

            // Start polling
            startWebhookPolling();
            fetchWebhookEvents();
        }

        function hideWebhookTester() {
            document.getElementById('webhookTester').classList.remove('visible');
            document.querySelector('.editor-area').style.display = '';
            document.querySelector('.explanation').style.display = '';
            stopWebhookPolling();
        }

        function startWebhookPolling() {
            stopWebhookPolling();
            webhookPollingInterval = setInterval(fetchWebhookEvents, 3000);
        }

        function stopWebhookPolling() {
            if (webhookPollingInterval) {
                clearInterval(webhookPollingInterval);
                webhookPollingInterval = null;
            }
        }

        async function fetchWebhookEvents() {
            try {
                let url = `${SUPABASE_URL}/rest/v1/webhook_events?session_id=eq.${webhookSessionId}&order=received_at.desc&limit=50`;
                if (webhookClearedAt) {
                    url += `&received_at=gt.${webhookClearedAt}`;
                }

                const resp = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    }
                });

                if (!resp.ok) return;
                const events = await resp.json();
                renderWebhookEvents(events);
            } catch (e) {
                // Silently fail - will retry on next poll
            }
        }

        let expandedEventIds = new Set();

        // Vision image handling
        let visionImageBase64 = null;

        function handleVisionFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                // Strip the data URL prefix (e.g. "data:image/jpeg;base64,")
                const fullData = e.target.result;
                visionImageBase64 = fullData.split(',')[1];
                document.getElementById('visionPreviewImg').src = fullData;
                document.getElementById('visionFilename').textContent = file.name + ' (' + (file.size / 1024).toFixed(0) + ' KB)';
                document.getElementById('visionDropZone').style.display = 'none';
                document.getElementById('visionPreview').classList.add('visible');
            };
            reader.readAsDataURL(file);
        }

        function handleVisionDrop(event) {
            event.preventDefault();
            document.getElementById('visionDropZone').classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file) handleVisionFile(file);
        }

        function clearVisionImage() {
            visionImageBase64 = null;
            document.getElementById('visionFileInput').value = '';
            document.getElementById('visionPreviewImg').src = '';
            document.getElementById('visionPreview').classList.remove('visible');
            document.getElementById('visionDropZone').style.display = '';
        }

        function toggleExplanation() {
            const content = document.getElementById('explanationContent');
            const toggle = document.getElementById('explanationToggle');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = 'Hide ‚ñ≤';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = 'Show ‚ñº';
            }
        }

        function toggleEvent(eventId) {
            if (expandedEventIds.has(eventId)) {
                expandedEventIds.delete(eventId);
            } else {
                expandedEventIds.add(eventId);
            }
            document.getElementById('evt-' + eventId)?.classList.toggle('expanded');
        }

        function renderWebhookEvents(events) {
            const list = document.getElementById('webhookEventList');

            if (!events || events.length === 0) {
                list.innerHTML = `
                    <li class="empty-state">
                        <span class="pulse-dot"></span>
                        Waiting for webhook events...<br>
                        <small>Events will appear here automatically when received</small>
                    </li>`;
                return;
            }

            list.innerHTML = events.map((evt, i) => {
                const time = new Date(evt.received_at);
                const timeStr = time.toLocaleTimeString();
                const payloadStr = JSON.stringify(evt.payload, null, 2);
                const isExpanded = expandedEventIds.has(evt.id);

                return `
                    <li class="webhook-event-item${isExpanded ? ' expanded' : ''}" id="evt-${evt.id}">
                        <div class="webhook-event-header" onclick="toggleEvent('${evt.id}')">
                            <span class="webhook-event-badge">${escapeHtml(evt.event_type || 'unknown')}</span>
                            <span style="color: #374151; font-size: 0.85em;">${escapeHtml(summarizePayload(evt.payload))}</span>
                            <span class="webhook-event-time">${timeStr}</span>
                            <span class="webhook-event-toggle">&#9654;</span>
                        </div>
                        <div class="webhook-event-body">
                            <pre>${escapeHtml(payloadStr)}</pre>
                        </div>
                    </li>`;
            }).join('');
        }

        function summarizePayload(payload) {
            if (!payload) return '';
            // Try to extract a useful summary
            if (payload.data && payload.data.order && payload.data.order.id) {
                return 'Order: ' + payload.data.order.id;
            }
            if (payload.data && payload.data.shipment && payload.data.shipment.id) {
                return 'Shipment: ' + payload.data.shipment.id;
            }
            const keys = Object.keys(payload);
            if (keys.length <= 3) return keys.join(', ');
            return keys.slice(0, 3).join(', ') + '...';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        async function clearWebhookEvents() {
            webhookEvents = [];
            expandedEventIds.clear();
            renderWebhookEvents([]);
            try {
                await fetch(`/clear-webhooks?session=${webhookSessionId}`, { method: 'DELETE' });
            } catch (e) {
                // silently fail ‚Äî UI is already cleared
            }
        }

        async function sendTestWebhook(eventType) {
            const url = getWebhookUrl();
            const now = new Date().toISOString();
            const testId = 'order_' + Date.now().toString().slice(-8);

            const payloads = {
                ORDER_CREATED: {
                    event: 'ORDER_CREATED',
                    timestamp: now,
                    data: {
                        order: {
                            id: testId,
                            accountOrderNumber: 'ORD-' + Date.now().toString().slice(-6),
                            status: 'OPEN',
                            currencyCode: 'USD',
                            amountSubtotals: {
                                duties: 12.50,
                                taxes: 11.86,
                                fees: 7.49,
                                shipping: 25.00,
                                items: 99.99
                            }
                        }
                    }
                },
                SHIPMENT_CREATED: {
                    event: 'SHIPMENT_CREATED',
                    timestamp: now,
                    data: {
                        shipment: {
                            id: 'shipment_' + Date.now().toString().slice(-8),
                            orderId: testId,
                            status: 'CREATED',
                            trackingNumbers: ['1Z999AA1' + Date.now().toString().slice(-10)],
                            carrier: 'UPS',
                            serviceLevel: 'Worldwide Expedited'
                        }
                    }
                },
                ORDER_CANCELED: {
                    event: 'ORDER_CANCELED',
                    timestamp: now,
                    data: {
                        order: {
                            id: testId,
                            accountOrderNumber: 'ORD-' + Date.now().toString().slice(-6),
                            previousStatus: 'OPEN',
                            status: 'CANCELED',
                            note: 'Customer requested cancellation'
                        }
                    }
                }
            };

            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payloads[eventType])
                });
                // Immediately poll for the new event
                setTimeout(fetchWebhookEvents, 500);
            } catch (e) {
                // Will show up on next poll cycle anyway
            }
        }

        // Fire a real webhook event based on API mutation response
        function fireWebhookFromResponse(responseData) {
            if (!responseData || !responseData.data) return;
            const data = responseData.data;
            const url = getWebhookUrl();
            const now = new Date().toISOString();

            let webhookPayload = null;

            if (data.orderCreate) {
                webhookPayload = {
                    event: 'ORDER_CREATED',
                    timestamp: now,
                    data: { order: data.orderCreate }
                };
            } else if (data.shipmentCreateWorkflow) {
                webhookPayload = {
                    event: 'SHIPMENT_CREATED',
                    timestamp: now,
                    data: { shipment: data.shipmentCreateWorkflow }
                };
            } else if (data.orderCancel) {
                webhookPayload = {
                    event: 'ORDER_CANCELED',
                    timestamp: now,
                    data: { order: data.orderCancel }
                };
            } else if (data.shipmentStatusUpdate) {
                webhookPayload = {
                    event: 'SHIPMENT_CANCELED',
                    timestamp: now,
                    data: { shipment: data.shipmentStatusUpdate }
                };
            }

            if (webhookPayload) {
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookPayload)
                }).then(() => {
                    setTimeout(fetchWebhookEvents, 500);
                }).catch(() => {});
            }
        }

        // Initialize
        loadConfig();
        startWebhookPolling();

        // Access gate
        const ACCESS_CODE = 'Zonosdemo26';
        function checkAccessCode() {
            const input = document.getElementById('accessCodeInput').value;
            if (input === ACCESS_CODE) {
                sessionStorage.setItem('zonos_access', '1');
                document.getElementById('accessGate').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            } else {
                document.getElementById('accessError').textContent = 'Incorrect access code. Try again.';
                document.getElementById('accessCodeInput').value = '';
                document.getElementById('accessCodeInput').focus();
            }
        }

        (function() {
            if (sessionStorage.getItem('zonos_access') === '1') {
                document.getElementById('accessGate').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            } else {
                document.getElementById('accessGate').style.cssText += '; display:flex !important;';
                document.getElementById('mainApp').style.display = 'none';
                setTimeout(() => document.getElementById('accessCodeInput').focus(), 100);
            }
        })();
    </script>
</body>
</html>
